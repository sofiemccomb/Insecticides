---
title: "Analysis"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown document will perform the panel linear model regressions for determining the relationship of agricultural and landscape variables on insectide use. The regressions are performed in separate R scripts that are sourced below and than analyzed. 
Current primary variables to be examined include:
1. pland_crops: fraction of crop areas per county
2. cropintensity: harvested acres per area of county cropland
3. SDI: crop diversity
4. msidi: simpsons landscape diversity 
5. te_shared_c_nc: shared edge length between natural and cropland divided by the total edge length of crop
6. mna_crops: patch size of cropland
7. largefarm_planted: acreage of harvested acres for farms >500acres

Secondary variables include:
1. crop covariates: soysmallgrain_planted + corn_planted + fruitveg_planted

Analyses are run for all counties pooled together (cp) and by Economic Research Service (ERS) Farm Resource Regions. County and Year fixed effects (and a combination of them) will be run for each regression.
Furthermore, two years (1997 and 2002) and missing data for SDI, so versions will be run excluding these purposefully.
Several combinations of variables and regressions will also be performed. 

## Data Preparation

This section will load the necessary packages and data, and run analyses on the data to examine the natural variation.

### Load Packages

```{r packages, message=F, warning=F}

#Load the needed packages (install first if necessary)
library(tidyverse) #Datatable manipulation
library(purrr) #For reduce function using full_join
library(plm) #Linear models for panel data
library(stats) #For as.formula function
library(car) # For calculating variance inflation factors (vif)
library(rlang) #For xtsum function creation
library(gdata) #For combine in xtsum function
library(ggplot2) #Data visualization
library(stargazer)#Regression and summary statistics tables

#Set options
options(scipen=999) #no scientific notation (all)

```


### Load Data

Loading the fulldata dataset created in the DataProcessing.Rmd, which was developed to perform the regression analyses.

```{r data, message=F, warning=F}

load("Data/DataProcessing/df/fulldata.rda")

```

### Examine Data with XTSUM

XTSUM (based on the stata function) examines the overall, within, and between variation found in a dataset.

```{r xtsum, message=F, warning=F}

#Source xtsumR script to examine variation within variables (fips, year) from fulldata and load saved analysis dataframe
source("R/Analysis/xtsumR.R")
#Script both creates R version of xtsum function and perform analyses, put into a dataframe and loaded here.
load("Data/Analysis/xtsum/xtsum_df.Rda")

```


## Run Panel Linear Model Regressions
Perform the regressions within separate R scripts, and have lists of the performed models loadable as rda file in order to perform analyses on the model results and create dataframes of results across models. All regressions are run using the "R/run_plm.R" script, which contains the run_plm function for performing panel linear model regressions. The script is sourced directly in the analysis scripts that are used below. The model inputs are created in each of the two scripts.

The general format is:  

run_plm<-function(predictors, data=fulldata,index = c("FIPS","Year"), model = "within",effect = "twoways"){
  Formula=stats::as.formula(paste("insect_planted ~ ", paste(predictors, collapse=" + ")))
  plm_model<-plm::plm(Formula, data = data,index = index,model = model,effect = effect)
  return(plm_model)}


Current versions of regressions to be performed for both pooled counties and by ERS regions include:
1. Using all 7 primary variables
2. Using 6 primary variables, excluding SDI
3. Using 6 primary variables, excluding SDI, but just for 2002-2017
4. All secondary crop covariates included

Twoways, individual, and time fixed effects models will be run for each regression, both as a within model and pooling model.

Default of regression is na.omit, so okay to currently rows with NA values as they will be excluded from the analysis by the regression functions. 


### 1) Counties Pooled (cp)

The cpmodels script performs the plm models for all counties pooled together using the run_plm functoin/script, and the list of model results are loaded and analyzed below.

#### Run panel regressions and save outputs as list of models in RDA format

```{r cpmodels, message=F, warning=F}

#Script runs the counties pooled (cp) regression models and creates .Rda file of list of plm models (edit models in R script)
source("R/Analysis/cpmodels.R") #Takes a few minutes to run both within and pooling models
  #Separated into multiple lists of models so that rda files were not too large for github (<100 MB)
load("Data/Analysis/models/CP/cpmodels_within.Rda") #Within model for steps 1-3 ( 7 and 6 primary varialbes)
load("Data/Analysis/models/CP/cpmodels_crops_within.Rda") #Pooling model for steps 1-3 ( 7 and 6 primary varialbes)
load("Data/Analysis/models/CP/cpmodels_pooling.Rda") #Within model for step 4 (rerun steps 1-3 with crop covariates)
load("Data/Analysis/models/CP/cpmodels_crops_pooling.Rda") #Pooling model for step 4 (rerun steps 1-3 with crop covariates)

```

#### Create dataframe of important model information from each model

```{r cp_df, message=F, warning=F}

#Combine within and pooling lists of models together to perform analyses
cpmodelswithin<-list(cpmodels_within, cpmodels_crops_within)
cpmodelspooling<-list(cpmodels_pooling, cpmodels_crops_pooling)

#Create dataframe of coefficients from each model (using within)
cp_coef_df<- lapply(cpmodelswithin,function(l){rownames_to_column(as.data.frame(l$coefficient), "variable")})%>% 
  purrr::reduce(full_join, by = "variable") %>% 
  setNames(c("variable", names(cpmodelswithin)))

#Create dataframe of p-values from each model (using within)
cp_pval_df<- lapply(cpmodelswithin, function(l){rownames_to_column(as.data.frame(summary(l)$coefficients[,4]),"variable")}) %>%
  purrr::reduce(full_join, by = "variable") %>% 
  setNames(c("variable", names(cpmodelswithin))) %>% 
   mutate_if(is.numeric, round, digits=5)

#Run variance inflation factor (vif) to look at multicollinearity between variables and look at correlation matrices
  #Can only run on model=pooling for plm 
    #However, since vif is about examining indepdenent variables, theoretically there is less need to control for effects 
    #VIF of 1=no correlation among predictors, >4 investigate, >10 serious correction

    #VIF on pooled data
    cp_vif<-lapply(cpmodelspooling, function(p){car::vif(p)})
    #Correlation matrix on within data
    cp_corr<-lapply(cpmodelswithin, function(v){cov2cor(v$vcov)})
    
#Write csv for each of the created dataframes and lists

```


#****Next Steps
2. Do same thing below with ERS- adding in for loop to subset by ERS and apply name that way (look at COA scrips?)
5. Notes and metadata on scripts and dataframes

Go back and add in the :: for calls, all libraries, and way more descriptions to all scripts and markdowns

Write cp results to csv extra
Keep up on ERS for loop of analyses was working on


### 2) By ERS Region

The ERS zones are 
1: Heartland
2: Northern Crescent
3: Northern Great Plains
4: Prairie Gateway
5: Eastern Uplands
6: Southern Seaboard
7: Fruitful Rim
8: Basin and Range
9: Mississippi Portal

    assign("a",get("b"))


```{r ERS, message=F, warning=F}

#Script runs the ERS (cp) regression models subset by ERS and creates .Rda file of list of plm models (edit models in R script)
source("R/Analysis/ERSmodels.R") #Takes a few minutes to run both within and pooling models for all ERS separately
  #Separated out crop covariate models so that rda files were not too large for github

#Will perform analyses on script products

#For loop through ERS and perform analyses for each ERS before combining
ERS<-1:9 #9 ERS Regions (defined in Markdown)
  for (e in ERS){
    #Load all 4 models within each ERS subfolder
    #Fix this to load all files- which will rewrite these files every time based on ERS # its on
    fn<-as.list(dir(paste0("Data/models/ERS/", e)), fullname=T)
    lapply(fn,load,.GlobalEnv)
  }

#then in the for loop put the cp analysis stuff from above and write dataframes of the results based on the number

#In here
  #Will load all rda files in each ERS subfolder from Data/models
#Perform ERS function for ERS number, creating and loading four rda model lists per ERS
#Create df and run vif, etc, by each ERS number and save files by, creating column writing in ERS number

#Outside of for loop reading in the dataframes and combine all the dataframes (especially coefficients and pval)
  #Order by the ERS value


#Create separate list of models for each ERS?
#And save?
#And then create dataframe for each ERS within the for loop
#And then can append the dataframes as we go or later
#Or save and do later cause can call it ERSmodels_1 with the number so can parse and run by # later


```




An object of class c("plm", "panelmodel").

A "plm" object has the following elements :

coefficients: the vector of coefficients,
vcov: the varianceâ€“covariance matrix of the coefficients,
residuals: the vector of residuals (these are the residuals of the (quasi-)demeaned model),
weights: (only for weighted estimations) weights as specified,
df.residual: degrees of freedom of the residuals,
formula	: an object of class "pFormula" describing the model,
model	: the model frame as a "pdata.frame" containing the variables used for estimation: the response is in first column followed by the other variables, the individual and time indexes are in the 'index' attribute of model,
ercomp	: an object of class "ercomp" providing the estimation of the components of the errors (for random effects models only),
aliased	: named logical vector indicating any aliased coefficients which are silently dropped by plm due to linearly dependent terms (see also detect.lindep),
call	:the call.

