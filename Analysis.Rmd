---
title: "Analysis"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown document will ...

The regression combinations I need:

Write out all the options 
Fraction Crop (Area)=pland_crops
Crop Intensity (harv ac/area crop (NLCD*CoA))=cropintensity
Crop diversity=SDI
Landscape diversity=msidi
Edge Natural habitat-crop=te_shared_c_nc
Patch size of cropland= mna_crops
Large Farms (Acreage harv acres to farms >500acres)=largefarm_planted


+crop covariates (fruits, veg, etc)=soysmallgrain_planted + corn_planted + fruitveg_planted
+county, year FES
Run for all counties pooled and Run for ERS regions
Possible additional: income_planted  + irrigate_planted

Model ignoring CDL as well to have all the years

The other regression column desired is shared edge length between natural and cropland (which is tel_naturalcrops_nc) divided by the total edge length of crop (tec_crops_nc), which is already a created column called te_shared_c_nc


## Data Formatting

```{r packages, message=F, warning=F}

#Load the needed packages (install first if necessary)
library(tidyverse) #Datatable manipulation
library(purrr) #For reduce function using full_join
library(plm) #Linear models for panel data
library(stats) #For as.formula function
library(car) # For calculating variance inflation factors (vif)
library(rlang) #For xtsum function creation
library(gdata) #For combine in xtsum function
library(ggplot2) #Data visualization
library(stargazer)#Regression and summary statistics tables

#Set options
options(scipen=999) #no scientific notation (all)

```

### Panel Fixed effects lm

Helpful websites: https://rstudio-pubs-static.s3.amazonaws.com/372492_3e05f38dd3f248e89cdedd317d603b9a.html 
https://cran.r-project.org/web/packages/plm/vignettes/plmPackage.html

#Good article on missing NA impacting lm analysis: https://stats.idre.ucla.edu/r/faq/how-does-r-handle-missing-values/
#Default is na.omit-works to exclude the NA value rows from analysis


Versions of regression:
1. All counties pooled (twoways, individual, time)
  a. All 7 variables (use var7)
  b. 6 variables (no CDL) (use var6)
  c. 6 variables (no CDL)-but just 3 years that have CDL (not 1997/2002) (use var6 on subset data)
  d. With all crop covariates
  e. Future choices: other variable combinations or just one variable each
2. ERS Regions
  *Same as above but substetted by regions

## Load Data

```{r data, message=F, warning=F}

load("Data/df/fulldata.rda")

```

### Examine Data with XTSUM

```{r xtsum, message=F, warning=F}

#Source xtsumR script to examine variation within variables (fips, year) from fulldata and load saved analysis dataframe
source("R/xtsumR.R")
load("Data/models/xtsum_df.Rda")

```

### Establish Model Inputs (For CP and ERS models)

```{r model inputs, message=F, warning=F}

#Create Variable Combinations
var7<-c("pland_crops","cropintensity", "msidi","mna_crops","largefarm_planted","te_shared_c_nc","SDI")
var6<-c("pland_crops","cropintensity", "msidi","mna_crops","largefarm_planted","te_shared_c_nc")
var7crops<-c("pland_crops","cropintensity", "msidi","mna_crops","largefarm_planted","te_shared_c_nc","SDI",
             "soysmallgrain_planted", "corn_planted", "fruitveg_planted")
var6crops<-c("pland_crops","cropintensity", "msidi","mna_crops","largefarm_planted","te_shared_c_nc",
             "soysmallgrain_planted", "corn_planted", "fruitveg_planted")

#Data subset that has 1997 and 2002 removed, since there are so many NAs for those years across the datasets
fulldata_3yrs<-fulldata[fulldata$Year!=1997&fulldata$Year!=2002,]

```


## Run Regressions
Perform the regressions within separate R scripts, and have lists of the performed models loadable as rda file in order to perform analyses on the model results and create dataframes of results across models. All regressions are run using the "R/run_plm.R" script, which contains the run_plm function for performing panel linear model regressions. The script is sourced directly in the analysis scripts that are used below.

The general format is:  

run_plm<-function(predictors, data=fulldata,index = c("FIPS","Year"), model = "within",effect = "twoways"){
  Formula=stats::as.formula(paste("insect_planted ~ ", paste(predictors, collapse=" + ")))
  plm_model<-plm::plm(Formula, data = data,index = index,model = model,effect = effect)
  return(plm_model)}

### 1) Counties Pooled (cp)

The cpmodels script performs the plm models for all counties pooled together using the run_plm functoin/script, and the list of model results are loaded and analyzed below.

#Create list of models and save that as as RDA

```{r cpmodels, message=F, warning=F}

#Script runs the counties pooled (cp) regression models and creates .Rda file of list of plm models (edit models in R script)
source("R/cpmodels.R") #Takes a few minutes to run both within and pooling models
load("Data/models/cpmodels_within.Rda")
load("Data/models/cpmodels_pooling.Rda")

```

#Create dataframe of important model information from list of cpmodels

```{r cp_df, message=F, warning=F}

#Create dataframe of coefficient from each model (using within)
cp_coef_df<- lapply(cpmodels_within,function(l){rownames_to_column(as.data.frame(l$coefficient), "variable")})%>% 
  purrr::reduce(full_join, by = "variable") %>% 
  setNames(c("variable", names(cpmodels_within)))

#Create dataframe of coefficient from each model (using within)
cp_pval_df<- lapply(cpmodels_within, function(l){rownames_to_column(as.data.frame(summary(l)$coefficients[,4]),"variable")}) %>%
  purrr::reduce(full_join, by = "variable") %>% 
  setNames(c("variable", names(cpmodels_within))) %>% 
   mutate_if(is.numeric, round, digits=5)

#Run variance inflation factor (vif) to look at multicollinearity between variables and look at correlation matrices
  #Can only run on model=pooling for plm (however vif about indepdenent variables so theoretically less need to control for effects) (https://stackoverflow.com/questions/20281055/test-for-multicollinearity-in-panel-data-r/20291097#20291097)
  #VIF of 1=no correlation among predictors, >4 investigate, >10 serious correction

    #VIF on pooled data
    cp_vif<-lapply(cpmodels_pooling, function(p){car::vif(p)})
    #Correlation matric on within data
    cp_corr<-lapply(cpmodels_within, function(v){cov2cor(v$vcov)})

```


#****Next Steps
2. Do same thing below with ERS- adding in for loop to subset by ERS and apply name that way (look at COA scrips?)
5. Notes and metadata on scripts and dataframes

Go back and add in the :: for calls, all libraries, and way more descriptions to all scripts and markdowns


### 2) By ERS Region

The ERS zones are 
1: Heartland
2: Northern Crescent
3: Northern Great Plains
4: Prairie Gateway
5: Eastern Uplands
6: Southern Seaboard
7: Fruitful Rim
8: Basin and Range
9: Mississippi Portal

    assign("a",get("b"))


```{r ERS, message=F, warning=F}

#Eventually by i and iterate through
data_by_ERS<-fulldata[fulldata$ERSCode==1,]
data_by_ERS_3yrs<-fulldata_3yrs[fulldata_3yrs$ERSCode==1,]

#For each option perform: twoways, individual, and time fixed effects

#A) All 7 variables
ERS_twoways_var7<-run_plm(predictors=var7, data=data_by_ERS)
ERS_individual_var7<-run_plm(predictors=var7, effect = "individual",data=data_by_ERS)
ERS_time_var7<-run_plm(predictors=var7, effect = "time",data=data_by_ERS)

#B) 6 variables (no CDL)
ERS_twoways_var6<-run_plm(predictors=var6,data=data_by_ERS)
ERS_individual_var6<-run_plm(predictors=var6, effect = "individual",data=data_by_ERS)
ERS_time_var6<-run_plm(predictors=var6, effect = "time",data=data_by_ERS)

#C) 6 variables (no CDL) but only 2007, 2012, and 2017 to match 3 years with CDL
ERS_twoways_var6_3yrs<-run_plm(predictors=var6, data=data_by_ERS_3yrs)
ERS_individual_var6_3yrs<-run_plm(predictors=var6, effect = "individual", data=data_by_ERS_3yrs)
ERS_time_var6_3yrs<-run_plm(predictors=var6, effect = "time", data=data_by_ERS_3yrs)

#D) All crops covariates, repeating A-C with these inclusions
#var7crops
ERS_twoways_var7crops<-run_plm(predictors=var7crops,data=data_by_ERS)
ERS_individual_var7crops<-run_plm(predictors=var7crops, effect = "individual",data=data_by_ERS)
ERS_time_var7crops<-run_plm(predictors=var7crops, effect = "time",data=data_by_ERS)

#var6crops
ERS_twoways_var6crops<-run_plm(predictors=var6crops,data=data_by_ERS)
ERS_individual_var6crops<-run_plm(predictors=var6crops, effect = "individual",data=data_by_ERS)
ERS_time_var6crops<-run_plm(predictors=var6crops, effect = "time",data=data_by_ERS)

#var6crops with data_by_ERS_3yrs
ERS_twoways_var6crops_3yrs<-run_plm(predictors=var6crops, data=data_by_ERS_3yrs)
ERS_individual_var6crops_3yrs<-run_plm(predictors=var6crops, effect = "individual", data=data_by_ERS_3yrs)
ERS_time_var6crops_3yrs<-run_plm(predictors=var6crops, effect = "time", data=data_by_ERS_3yrs)

#Create separate list of models for each ERS?
#And save?
#And then create dataframe for each ERS within the for loop
#And then can append the dataframes as we go or later
#Or save and do later cause can call it ERSmodels_1 with the number so can parse and run by # later


```









```{r}


#variables <- c("harv_county", "SDI")
variables<-c("pland_crops","cropintensity","SDI", "msidi","mna_crops","largefarm_planted","te_shared_c_nc")
#Could make a whole bunch of versions and then apply the function to the list of variable lists, and then combine the results

modelnm<-run_plm(predictors=variables)
save(modelnm, file = paste0("Data/models/testing.rda"))

#Instead of stargazer maybe just save rda of each model
#And later go through whole folder, pull them in, and put info from them in compiled text pdf
#And then maybe csv


```


#Potential possibility of extracting information from heach model and running it
#Could list the models?

An object of class c("plm", "panelmodel").

A "plm" object has the following elements :

coefficients: the vector of coefficients,
vcov: the varianceâ€“covariance matrix of the coefficients,
residuals: the vector of residuals (these are the residuals of the (quasi-)demeaned model),
weights: (only for weighted estimations) weights as specified,
df.residual: degrees of freedom of the residuals,
formula	: an object of class "pFormula" describing the model,
model	: the model frame as a "pdata.frame" containing the variables used for estimation: the response is in first column followed by the other variables, the individual and time indexes are in the 'index' attribute of model,
ercomp	: an object of class "ercomp" providing the estimation of the components of the errors (for random effects models only),
aliased	: named logical vector indicating any aliased coefficients which are silently dropped by plm due to linearly dependent terms (see also detect.lindep),
call	:the call.


```{r}

myFun <-
function(plm)
{
out <- c(plm$coefficients[1],
	lm$coefficients[2],
	length(lm$model$y),
	summary(lm)$coefficients[2,2],
	pf(summary(lm)$fstatistic[1], summary(lm)$fstatistic[2],
summary(lm)$fstatistic[3], lower.tail = FALSE),
	summary(lm)$r.squared)
names(out) <- c("intercept","slope","n","slope.SE","p.value","r.squared")
return(out)}


#Edit above on the list of models

#Plm object has the follwing elements
#want to save and report the coefficients,

#vcov is cool but har to include in csv table

cp_var7$coefficients
cp_var7$vcov



```

