---
title: "Supplementary"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Saved files for Supplementary Rmd do not have their own folder under Data, and instead can be found under the visualize folder, so that all present-day visualizations can be kept together for easy viewing.


##Load Packages

```{r}
#Load the needed packages (install first if necessary)
library(tidyverse) #Datatable manipulation (all functions)
library(xtable) #Create VIF tables with xtable
library(corrplot) #Correlation Plot
library(RColorBrewer) #Color Brewer Palettes
library(sf)#shapefiles
library(ggplot2) #Plotting ggplot
library(stargazer)#Making regression tables
library(data.table)#Table format needed for conley
library(lfe)#Need for felm, for conley
library(Rcpp)#Need to read .cpp file for conley
library(RcppArmadillo)#Need to read .cpp file for conley
library(dendextend)#extending dendogram objects, for conley maybe
library(tmap) #Make vector maps 
library(clubSandwich) #For coeftest

#Set options
  options(scipen=999) #no scientific notation (all)

```



## VIF Tables
Make table with VIFs or maybe a correlation plot (library = corrplot) for the landscape and patch metrics (Percent crop, edge density crops, mean patch size crops, large farms, crop diversity, landscape diversity) for final best model. 

```{r}

#Load final models with edge crops and with natural-crop edges
vif_diversity<-readr::read_csv("Data/Analysis/df/vif_diversity.csv")
edgemodels_vif<-readr::read_csv("Data/Analysis/df/edgemodels_vif.csv")

vif_cropedge<-vif_diversity[,c(1,4)] %>% 
  mutate(Variable=c("Percent Cropland", "Crop Edge Density", "Average Crop Area", 
                    "Proportion Large Farms", "Proportion soybeans & small grains", 
                    "Proportion corn", "Proportion fruit & vegetables", 
                    "Landscape Diversity", "Cropland Diversity", "Year", "ASD Code")) %>% 
  select(3,2)
colnames(vif_cropedge)<-c("Variable", "VIF")

vif_naturalcropedge<-edgemodels_vif %>%  
  filter(model=="natural") %>% 
    mutate(Variable=c("Percent Cropland", "Natural-Crop Edge Density", "Average Crop Area", 
                    "Proportion Large Farms", "Proportion soybeans & small grains", 
                    "Proportion corn", "Proportion fruit & vegetables", 
                    "Landscape Diversity", "Cropland Diversity", "Year", "ASD Code")) %>% 
  select(6,4)
colnames(vif_naturalcropedge)<-c("Variable", "VIF")

write_csv(vif_cropedge, "Data/Visualize/VIF/cropedge_vif_table.csv")
write_csv(vif_naturalcropedge, "Data/Visualize/VIF/naturalcropedge_vif_table.csv")

#Print xtables to html, then snip to PNGs
print.xtable(xtable(vif_cropedge), type="html", file="Data/Visualize/VIF/cropedge_vif_table.html",include.rownames=F)
print.xtable(xtable(vif_naturalcropedge), type="html", file="Data/Visualize/VIF/naturalcropedge_vif_table.html",include.rownames=F)

#############
#Correlation Plots for best models-with crop edge and natural-crop edge
# load("Data/Analysis/models/df/data_diversity.Rda")
# load("Data/Analysis/models/df/data_natural.Rda")
# 
# corrdf_cropedge<-data_diversity[,6:14] #Only the covariates
# corrdf_natcropedge<-data_natural[,6:14]#Only the covariates

# #Plot and save correlation matrices
# png(filename="Data/Visualize/VIF/cropedge_corrplot.png",width=600, height=600)
# corrplot::corrplot(cor(corrdf_cropedge), type = "upper", order = "hclust", 
#          tl.col = "black", tl.srt = 45,col=brewer.pal(n=8, name="RdYlBu"))
# dev.off()
# 
# png(filename="Data/Visualize/VIF/natcropedge_corrplot.png", width=600, height=600)
# corrplot::corrplot(cor(corrdf_natcropedge), type = "upper", order = "hclust", 
#          tl.col = "black", tl.srt = 45,col=brewer.pal(n=8, name="RdYlBu"))
# dev.off()

#Use data_natural as base, demean the covariates based on ASDCode and Year
# load("Data/DataProcessing/df/fulldata.rda")
# data_correlation<-fulldata %>% 
#   select(FIPS, Year, ASDCode, ERSCode,
#          insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
#          soysmallgrain_planted, corn_planted, fruitveg_planted,
#          msidi, SDI) %>% 
#     filter(!Year==2002)%>% #Only 3 years of data
#   na.omit() %>% #8939 observations (match crops_3yrs and diversity)
#     rename(Insecticide=insect_planted) %>% 
#   mutate(PercentCrop=pland_crops-ave(pland_crops, Year)-ave(pland_crops, ASDCode),
#          NaturalCropEdge=natural_crops_ed-ave(natural_crops_ed, Year)-ave(natural_crops_ed, ASDCode),
#          MeanCropArea=mna_crops-ave(mna_crops, Year)-ave(mna_crops, ASDCode),
#          LargeFarms=largefarm_planted-ave(largefarm_planted, Year)-ave(largefarm_planted, ASDCode),
#          SoyGrains=soysmallgrain_planted-ave(soysmallgrain_planted, Year)-ave(soysmallgrain_planted, ASDCode),
#          Corn=corn_planted-ave(corn_planted, Year)-ave(corn_planted, ASDCode),
#          FruitVeg=fruitveg_planted-ave(fruitveg_planted, Year)-ave(fruitveg_planted, ASDCode),
#          LandDiversity=msidi-ave(msidi, Year)-ave(msidi, ASDCode),
#          CropDiversity=SDI-ave(SDI, Year)-ave(SDI, ASDCode)) %>% 
#   select(PercentCrop, NaturalCropEdge, MeanCropArea, LargeFarms, SoyGrains, Corn, FruitVeg, LandDiversity, CropDiversity)
# 
# #Using this site as basis:https://stackoverflow.com/questions/27431735/demeaning-data-on-multiple-levels-in-r
# 
# png(filename="Data/Visualize/VIF/demeaned_corrplot.png",width=600, height=600)
# corrplot::corrplot(cor(data_correlation), type = "upper", order = "hclust", 
#           tl.col = "black", tl.srt = 45,col=brewer.pal(n=8, name="RdYlBu"))
# dev.off()
# 

load("Data/DataProcessing/df/fulldata.rda")
data_correlation<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  na.omit()#8939 observations (match crops_3yrs and diversity)
  
data_corr<-data_correlation %>% 
  mutate(Insecticide=residuals(lm(insect_planted~factor(ASDCode)+factor(Year), data=data_correlation)),
         PercentCrop=residuals(lm(pland_crops~factor(ASDCode)+factor(Year), data=data_correlation)),
         NaturalCropEdge=residuals(lm(natural_crops_ed~factor(ASDCode)+factor(Year), data=data_correlation)),
         MeanCropArea=residuals(lm(mna_crops~factor(ASDCode)+factor(Year), data=data_correlation)),
         LargeFarms=residuals(lm(largefarm_planted~factor(ASDCode)+factor(Year), data=data_correlation)),
         SoyGrains=residuals(lm(soysmallgrain_planted~factor(ASDCode)+factor(Year), data=data_correlation)),
         Corn=residuals(lm(corn_planted~factor(ASDCode)+factor(Year), data=data_correlation)),
         FruitVeg=residuals(lm(fruitveg_planted~factor(ASDCode)+factor(Year), data=data_correlation)),
         LandDiversity=residuals(lm(msidi~factor(ASDCode)+factor(Year), data=data_correlation)),
         CropDiversity=residuals(lm(SDI~factor(ASDCode)+factor(Year), data=data_correlation)))%>% 
  select(PercentCrop, NaturalCropEdge, MeanCropArea, LargeFarms, SoyGrains, Corn, FruitVeg, LandDiversity, CropDiversity)

#Using this site as basis:https://stackoverflow.com/questions/27431735/demeaning-data-on-multiple-levels-in-r

png(filename="Data/Visualize/VIF/residuals_corrplot.png",width=600, height=600)
corrplot::corrplot(cor(data_corr), type = "upper", order = "hclust", 
          tl.col = "black", tl.srt = 45,col=brewer.pal(n=8, name="RdYlBu"))
dev.off()



```


## Conley Standard Errors
Perform Conley standard errors using best model on centroids of counties (200 km, no time lags) to examine spatial autocorrelation on final best model, without regional effects (http://www.trfetzer.com/using-r-to-estimate-spatial-hac-errors-per-conley/)

### Create linear model

```{r}


# Loading R function to compute Conley SEs:
#Did not work by itself, but files are downloaded
    # source("~/Dropbox/ConleySEs/ConleySEs_17June2015.R")#original
    # install.packages("devtools")
    # library(devtools)
    # install_github("shommazumder/shomR")
    # library(shomR)

#Loading sample data and preparing for model
load("Data/DataProcessing/df/fulldata.rda")
data_conley<-fulldata %>% #Starting same as data_natural
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% #8939 observations (match crops_3yrs and diversity)
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=pland_crops,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi,
         CropDiversity=SDI)

#Need to add lat and lon values from map of FIPS
counties<-read_sf(dsn = "C:/Users/shemc/Documents/UCSB/NLCD/Data/TIGER2018_Counties", layer = "tl_2018_us_county") %>%  
  dplyr::mutate(FIPS=paste0(STATEFP,COUNTYFP))
counties<-st_transform(counties, "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=WGS84
                     +towgs84=0,0,0,-0,-0,-0,0 +units=m +no_defs ") #Project counties to nlcd projection
contig48_counties<-subset(counties,counties$STATEFP!="02"& counties$STATEFP!="15"&
                            counties$STATEFP!="60"&counties$STATEFP!="66"&
                            counties$STATEFP!="69"&counties$STATEFP!="72"&
                            counties$STATEFP!="74"&counties$STATEFP!="78") %>% 
  select(FIPS, geometry)

#Get centroids
sf_cent <- st_centroid(contig48_counties)
sf_coord<-st_coordinates(sf_cent)
fips_coords<-cbind(sf_cent, sf_coord) %>% 
  mutate(FIPS=as.numeric(FIPS))

#Join data with regression data
conleydf<-data_conley %>% 
  left_join(fips_coords) %>% 
  rename(lat=X, lon=Y)

#Double check calculated correctly by plotting (looks good)
  # library(tmap)
  # tm_shape(contig48_counties)+tm_fill(col="white")+
  #   tm_borders(col = "gray40", lwd = 1)+
  # tm_shape(sf_cent) + 
  #   tm_dots()


lm_conley<-felm(Insecticide~PercentCrop+NaturalCropEdge+MeanCropArea+LargeFarms+
                  SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity -1 |Year +ASDCode | 0 | lat +lon,
                data=conleydf, keepCX=TRUE) #Identical coefficients to lm_natural, slightly different SE

conley_coef<-coefficients(lm_conley) %>%
  round(3) %>% 
  data.frame() %>% 
  tibble::rownames_to_column()
colnames(conley_coef)<-c("Variable", "Estimate")

conley_cse<-lm_conley$cse %>% 
  round(3) %>% 
  data.frame() %>% 
  tibble::rownames_to_column()
colnames(conley_cse)<-c("Variable", "Cluster SE")

stargazer::stargazer(lm_conley, type="text", out="Data/Visualize/conley/conley_stargazer_table.txt",
                               covariate.labels=c("Percent Cropland", "Natural-Crop Edge Density", 
                                                  "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"))


    # Use the felm() from the lfe package to estimate model with year and county fixed effects.
    # Two important points:
    # (1) We specify our latitude and longitude coordinates as the cluster variables, so that they are included in the output (m).
    # (2) We specify keepCx = TRUE, so that the centered data is included in the output (m).

```

### Perform Conley SE

```{r}

#Conley function will not work (not the downloaded one, or me recreating it)
  #So have created the function effectively below, still can call the cpp function and iterate Obs function
  #Code developed from https://github.com/shommazumder/shomR

#0 lag time and 200km

#Define variables
reg = lm_conley
unit = "ASDCode" 
time = "Year"
lat = "lat" 
lon = "lon"
dist_fn = "SH" #default is "haversine"
dist_cutoff = 200 #default is 500
lag_cutoff = 0 #default is 5
cores = 1
verbose = TRUE
kernel = "bartlett" 
# lat_scale = 111 #seem not to need
balanced_pnl = FALSE

pkgs <- c("data.table", "lfe", "geosphere", "Rcpp", "RcppArmadillo")
invisible(sapply(pkgs, require, character.only = TRUE))
library(Rcpp)
sourceCpp("R/Visualize/cpp-functions.cpp")


  Fac2Num <- function(x) {as.numeric(as.character(x))}
  source("R/Visualize/iterateObs.R")
  if(cores > 1) {invisible(library(parallel))}
  
  if(class(reg) == "felm") {
    Xvars <- rownames(reg$coefficients)
    dt = data.table(reg$cY, reg$cX,
                    fe1 = Fac2Num(reg$fe[[1]]),
                    fe2 = Fac2Num(reg$fe[[2]]),
                    coord1 = Fac2Num(reg$clustervar[[1]]),
                    coord2 = Fac2Num(reg$clustervar[[2]]))
    setnames(dt,
             c("fe1", "fe2", "coord1", "coord2"),
             c(names(reg$fe), names(reg$clustervar)))
    dt = dt[, e := as.numeric(reg$residuals)]
    
  } else {
    message("Model class not recognized.")
    break
  }
  
  n <- nrow(dt)
  k <- length(Xvars)
  
  # Renaming variables:
  orig_names <- c(unit, time, lat, lon)
  new_names <- c("unit", "time", "lat", "lon")
  setnames(dt, orig_names, new_names)
  
  # Empty Matrix:
  XeeX <- matrix(nrow = k, ncol = k, 0)
  
  #================================================================
  # Correct for spatial correlation:
  timeUnique <- unique(dt[, time])
  Ntime <- length(timeUnique)
  setkey(dt, time)
  
  if(verbose){message("Starting to loop over time periods...")}
  
  if(balanced_pnl){
    sub_dt <- dt[time == timeUnique[1]]
    lat <- sub_dt[, lat]; lon <- sub_dt[, lon]; rm(sub_dt)
    
    if(balanced_pnl & verbose){message("Computing Distance Matrix...")}
    
    d <- DistMat(cbind(lat, lon), cutoff = dist_cutoff, kernel, dist_fn)
    rm(list = c("lat", "lon"))
  }
  
  if(cores == 1) {
    XeeXhs <- lapply(timeUnique, function(t) iterateObs(sub_index = t,
                                                        type = "spatial", cutoff = dist_cutoff))
  } else {
    XeeXhs <- mclapply(timeUnique, function(t) iterateObs(sub_index = t,
                                                          type = "spatial", cutoff = dist_cutoff), mc.cores = cores)
  }
  
  if(balanced_pnl){rm(d)}
  
  # First Reduce:
  XeeX <- Reduce("+",  XeeXhs)
  
  # Generate VCE for only cross-sectional spatial correlation:
  X <- as.matrix(dt[, eval(Xvars), with = FALSE])
  invXX <- solve(t(X) %*% X) * n
  
  V_spatial <- invXX %*% (XeeX / n) %*% invXX / n
  
  V_spatial <- (V_spatial + t(V_spatial)) / 2
  
  if(verbose) {message("Computed Spatial VCOV.")}
  
  #================================================================
  # Correct for serial correlation:
  panelUnique <- unique(dt[, unit])
  Npanel <- length(panelUnique)
  setkey(dt, unit)
  
  if(verbose){message("Starting to loop over units...")}
  
  if(cores == 1) {
    XeeXhs <- lapply(panelUnique, function(t) iterateObs(sub_index = t,
                                                         type = "serial", cutoff = lag_cutoff))
  } else {
    XeeXhs <- mclapply(panelUnique,function(t) iterateObs(sub_index = t,
                                                          type = "serial", cutoff = lag_cutoff), mc.cores = cores)
  }
  
  XeeX_serial <- Reduce("+",  XeeXhs)
  
  XeeX <- XeeX + XeeX_serial
  
  V_spatial_HAC <- invXX %*% (XeeX / n) %*% invXX / n
  V_spatial_HAC <- (V_spatial_HAC + t(V_spatial_HAC)) / 2
  
  return_list <- list(
    "OLS" = reg$vcv,
    "Spatial" = V_spatial,
    "Spatial_HAC" = V_spatial_HAC)


```


### Format Conley SE, and save coefficients and SE

```{r}

SE<-return_list 
SE_df<-sapply(SE, function(x) diag(sqrt(abs(x)))) %>% round(3) %>% #Added abs, does not change values, just keeps headers
  data.frame() %>% 
  tibble::rownames_to_column() %>% 
  rename(Variable=rowname)

final_conley_df<-conley_coef %>% 
  dplyr::left_join(conley_cse, by="Variable") %>% 
  dplyr::left_join(SE_df, by="Variable") %>% 
  mutate(Variable=c("Percent Cropland", "Natural-Crop Edge Density", "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"))
final_conley_df

#Save as csv
write_csv(final_conley_df, "Data/Visualize/conley/final_conley_df.csv")

```


## Robustness Check: <1% Cropland
Remove counties with <1% of cropland (NLCD) and run best model, reporting in supplementary section on how many observations it removes; create map showing which counties are removed

### Create and explore the <1% dataset

```{r}

load("Data/DataProcessing/df/fulldata.rda")

data_pcrop_less1perc<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  filter(pland_crops>=1) %>% 
  na.omit() %>% #6590 observations 
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=pland_crops,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi,
         CropDiversity=SDI)
#Original data_natural had 8939 observations, and data_pcrop_less1perc has 6590 observations

#Dataset to compare it to is data_natural
load("Data/Analysis/models/df/data_natural.Rda")
obsdiff<-nrow(data_natural)-nrow(data_pcrop_less1perc) #2349
obspcdiff<-obsdiff/nrow(data_natural)*100 #~26% of observations lost
uniqFIPS<-length(unique(data_natural$FIPS))-length(unique(data_pcrop_less1perc$FIPS))#798

#Math to compare the datasets-figure out which FIPS different and which years
natural_subset<-data_natural %>% select(FIPS, Year) %>% mutate(Data="natural")
pcrop_subset<-data_pcrop_less1perc %>% select(FIPS, Year)%>% mutate(Data="pcrop")

merge_subset<-full_join(natural_subset, pcrop_subset, by = c("FIPS", "Year"))
rem_fips <- merge_subset[is.na(merge_subset$Data.y),] %>% #2349 rows-combo of 
  select(FIPS, Year)
uniqfips<-unique(rem_fips$FIPS)
uniqfips_num<-length(uniqfips)#838 counties
year_counts<-table(rem_fips$Year)#800 counts 2007, 776 counts 2012, 772 countes 2017

#Dataframe to combine
pcrop_df<-merge_subset %>% 
  mutate(Pcrop=ifelse(Data.y=="pcrop", 0, 1))#1 given to low crop, aka FIPS removed
pcrop_df$Pcrop[is.na(pcrop_df$Pcrop)]<- 1
pcrop_df<-pcrop_df %>% select(FIPS, Pcrop)

#Count how many times FIPS removed (how many times FIPS has a 0)
final_pcrop_df<-unique(transform(pcrop_df, Pcrop=ave(pcrop_df$Pcrop, pcrop_df$FIPS, FUN=sum)))

#Plot missing FIPS (aka FIPS with low cropland)
counties<-read_sf(dsn = "C:/Users/shemc/Documents/UCSB/NLCD/Data/TIGER2018_Counties", layer = "tl_2018_us_county") %>%  
  dplyr::mutate(FIPS=paste0(STATEFP,COUNTYFP))
counties<-st_transform(counties, "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=WGS84
                     +towgs84=0,0,0,-0,-0,-0,0 +units=m +no_defs ") #Project counties to nlcd projection
contig48_counties<-subset(counties,counties$STATEFP!="02"& counties$STATEFP!="15"&
                            counties$STATEFP!="60"&counties$STATEFP!="66"&
                            counties$STATEFP!="69"&counties$STATEFP!="72"&
                            counties$STATEFP!="74"&counties$STATEFP!="78") %>% 
  select(FIPS, geometry) %>% 
  mutate(FIPS=as.numeric(FIPS))

#Join counties data with uniqfips
pcrop_sf<-contig48_counties %>% 
  full_join(final_pcrop_df, by="FIPS") %>% 
  mutate(Pcrop=as.integer(Pcrop))


#Map by how many times FIPS removed for <1% Cropland
  tm_count<-tm_shape(pcrop_sf)+tm_fill("Pcrop", title="Numbers of years \n county is <1% cropland ",
                             breaks=c(0,1,2,3,4),
                             labels=c("0", "1", "2", "3"),
                             textNA = "No Data", colorNA = "gray80")+
    tm_borders(col = "gray40", lwd = 1)
  tmap_save(tm = tm_count, filename = "Data/Visualize/robustness/pcrop_less1pc/counties_lessthan1percentcrop_NLCD.png", dpi = 300)

```

### Run final model on <1% cropland dataset and produce stargazer table of results with cluster robust SE

```{r}

#6590 observations
lm_pcrop_less1pc<-lm(Insecticide~PercentCrop+NaturalCropEdge+MeanCropArea+LargeFarms+
                  SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity+
                  factor(Year)+factor(ASDCode), data=data_pcrop_less1perc)
df_coef_pcropless1pc<-lm_pcrop_less1pc %>% 
  clubSandwich::coef_test(vcov = "CR2", cluster = data_pcrop_less1perc$ASDCode, test = "Satterthwaite")

stargazer::stargazer(lm_pcrop_less1pc, type="text", omit=c("ASDCode","Year"), out="Data/Visualize/robustness/pcrop_less1pc/pcrop_less1pc_stargazer.txt",
                               covariate.labels=c("Percent Cropland", "Natural-Crop Edge Density", 
                                                  "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_pcropless1pc[,2]),p=list(df_coef_pcropless1pc[,5]))

```


### Quick check to <1% cropland based on harv_crop from CoA, but run regression based on NLCD

```{r}

load("Data/DataProcessing/df/fulldata.rda")

data_coa_cropless1pc<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode, harv_county,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  filter(harv_county>=0.01) %>% 
  na.omit() %>% #8319 observations 
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=pland_crops,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi,
         CropDiversity=SDI)

#8319 observations
lm_coa_cropless1pc<-lm(Insecticide~PercentCrop+NaturalCropEdge+MeanCropArea+LargeFarms+
                  SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity+
                  factor(Year)+factor(ASDCode), data=data_coa_cropless1pc)
df_coef_coa_cropless1pc<-lm_coa_cropless1pc %>% 
  clubSandwich::coef_test(vcov = "CR2", cluster = data_coa_cropless1pc$ASDCode, test = "Satterthwaite")

stargazer::stargazer(lm_coa_cropless1pc, type="text", omit=c("ASDCode","Year"), out="Data/Visualize/robustness/pcrop_less1pc/coa_cropless1pc_stargazer.txt",
                               covariate.labels=c("Percent Cropland", "Natural-Crop Edge Density", 
                                                  "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_coa_cropless1pc[,2]),p=list(df_coef_coa_cropless1pc[,5]))

```

Removing by NLCD has bigger shift in estimates than removing by CoA which has almost no shift. Probably because by CoA has very similar number of observations as best model. However, both models are "improved", as they have R2 values of ~0.74, about 0.04 higher than best model (natural model).

## Robustness Check: Percent Crop (NLCD) vs Harvested Crop (CoA)
Replaced percent crop (NLCD) with harvested crop per county (CoA) and re-run best model to identify if results change

```{r}

load("Data/DataProcessing/df/fulldata.rda")

data_harvcrop<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode, harv_county,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% #8939 observations (same as data_natural)
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         HarvestedCropland=harv_county,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi,
         CropDiversity=SDI)

#8939 observations
lm_harvcrop<-lm(Insecticide~HarvestedCropland+NaturalCropEdge+MeanCropArea+LargeFarms+
                  SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity+
                  factor(Year)+factor(ASDCode), data=data_harvcrop)
df_coef_harvcrop<-lm_harvcrop %>% 
  clubSandwich::coef_test(vcov = "CR2", cluster = data_harvcrop$ASDCode, test = "Satterthwaite")

stargazer::stargazer(lm_harvcrop, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/robustness/harvcrop/harvcrop_stargazer.txt",
                               covariate.labels=c("Proportion Harvested Cropland", "Natural-Crop Edge Density", 
                                                  "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_harvcrop[,2]),p=list(df_coef_harvcrop[,5]))

```

Almost identical results, only the sign switched for average crop area, and a few are very slightly different.
Harv_crop and pland crops almost identical estimates.
Not investigating <1% cropland on this model, because should be very similar to effect seen when using pland_crop.


##Robusntess Check: Combine Above Models
```{r}

#Read in natural for comparison
load("Data/Analysis/models/lm_natural.Rda")
df_coef_natural<-lm_natural %>% 
  clubSandwich::coef_test(vcov = "CR2", cluster = data_natural$ASDCode, test = "Satterthwaite")

#Version of harvcrop with same percentcrop name
data_harvcrop_comb<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode, harv_county,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% #8939 observations (same as data_natural)
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=harv_county,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi,
         CropDiversity=SDI)

#8939 observations
lm_harvcrop_comb<-lm(Insecticide~PercentCrop+NaturalCropEdge+MeanCropArea+LargeFarms+
                  SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity+
                  factor(Year)+factor(ASDCode), data=data_harvcrop_comb)
df_coef_harvcrop_comb<-lm_harvcrop_comb %>% 
  clubSandwich::coef_test(vcov = "CR2", cluster = data_harvcrop_comb$ASDCode, test = "Satterthwaite")

#Stargazer of results together
stargazer::stargazer(lm_natural, lm_pcrop_less1pc, lm_coa_cropless1pc, lm_harvcrop_comb, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/robustness/robustmodels_stargazer.txt",
                               covariate.labels=c("Percent Cropland", "Natural-Crop Edge Density", 
                                                  "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_natural[,2],df_coef_pcropless1pc[,2],df_coef_coa_cropless1pc[,2],df_coef_harvcrop_comb[,2]),
                     p=list(df_coef_natural[,5],df_coef_pcropless1pc[,5],df_coef_coa_cropless1pc[,5],df_coef_harvcrop_comb[,5]))


```



## Robustness Check: Fixed Effects County vs ASD
Run best model with fixed effects on county instead of ASD for supplementary figure, including table of xtsum output showing ASD better than county level in terms of remaining variation

```{r}

#Use data_natural, only changing the lm model
load("Data/Analysis/models/df/data_natural.Rda")

#8939 observations
lm_FIPS<-lm(Insecticide~PercentCrop+NaturalCropEdge+MeanCropArea+LargeFarms+
                  SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity+
                  factor(Year)+factor(FIPS), data=data_natural)
#Saved to put on R server online

#Cluster around ASDCode because FIPS too many, won't work-ran on R server so faster
# df_coef_FIPS<-lm_FIPS%>%
#   clubSandwich::coef_test(vcov = "CR2", cluster = data_natural$ASDCode, test = "Satterthwaite")
load("Data/Visualize/robustness/FIPS/df_coef_FIPS.Rda")



stargazer::stargazer(lm_FIPS, type="text", omit=c("FIPS","Year"),
                     out="Data/Visualize/robustness/FIPS/FIPS_stargazer.txt",
                               covariate.labels=c("Percent Cropland", "Natural-Crop Edge Density", 
                                                  "Average Crop Area", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables",
                             "Landscape Diversity", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_FIPS[,2]),p=list(df_coef_FIPS[,5]))


```

Another reason to justify moving from FIPS to ASDCode is the processing speed. For clustering, clustering around 303 ASD vs 3031 FIPS (for data_natural dataset). Faster processing, less memory storage.

## CoA only cross-sectional models
Retrive CoA data back to 1987 and create boxplots and run cross-sectional models on CoA data (large farm, crop covariates, harvested crop) from 1987-2017

WAIT UNTIL CAN ACCESS 1987 AND 1992 COA DATA
Currently setting it up with 1997-2017 data

```{r}

load("Data/DataProcessing/df/fulldata.rda")

data_coa<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, harv_county, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted) %>% 
  na.omit() %>% #14938 observations
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         HarvestedCrop=harv_county,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted)

lm_coa<-lm(Insecticide~HarvestedCrop+LargeFarms+SoyGrains+Corn+FruitVeg+factor(Year)+factor(ASDCode), data=data_coa)
df_coef_coa<-lm_coa%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_coa$ASDCode, test = "Satterthwaite")

stargazer::stargazer(lm_coa, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/coa/coa_stargazer.txt",
                               covariate.labels=c("Harvested Cropland", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_coa[,2]),p=list(df_coef_coa[,5]))


#By year, with spatial fixed effects
data_coa_1997<-data_coa %>% filter(Year==1997)
data_coa_2002<-data_coa %>% filter(Year==2002)
data_coa_2007<-data_coa %>% filter(Year==2007)
data_coa_2012<-data_coa %>% filter(Year==2012)
data_coa_2017<-data_coa %>% filter(Year==2017)


#Models by year
lm_coa_1997<-lm(Insecticide~HarvestedCrop+LargeFarms+SoyGrains+Corn+FruitVeg+factor(ASDCode), data=data_coa_1997)
lm_coa_2002<-lm(Insecticide~HarvestedCrop+LargeFarms+SoyGrains+Corn+FruitVeg+factor(ASDCode), data=data_coa_2002)
lm_coa_2007<-lm(Insecticide~HarvestedCrop+LargeFarms+SoyGrains+Corn+FruitVeg+factor(ASDCode), data=data_coa_2007)
lm_coa_2012<-lm(Insecticide~HarvestedCrop+LargeFarms+SoyGrains+Corn+FruitVeg+factor(ASDCode), data=data_coa_2012)
lm_coa_2017<-lm(Insecticide~HarvestedCrop+LargeFarms+SoyGrains+Corn+FruitVeg+factor(ASDCode), data=data_coa_2017)

#CRSE by year
df_coef_coa_1997<-lm_coa_1997%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_coa_1997$ASDCode, test = "Satterthwaite")
df_coef_coa_2002<-lm_coa_2002%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_coa_2002$ASDCode, test = "Satterthwaite")
df_coef_coa_2007<-lm_coa_2007%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_coa_2007$ASDCode, test = "Satterthwaite")
df_coef_coa_2012<-lm_coa_2012%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_coa_2012$ASDCode, test = "Satterthwaite")
df_coef_coa_2017<-lm_coa_2017%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_coa_2017$ASDCode, test = "Satterthwaite")

#Stargazer table of results
stargazer::stargazer(lm_coa_1997, lm_coa_2002, lm_coa_2007, lm_coa_2012, lm_coa_2017,
                     type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/coa/coa_year_stargazer.txt",
                     covariate.labels=c("Harvested Cropland", "Proportion Large Farms",
                             "Proportion soybeans and small grains", "Proportion corn", "Proportion fruit and vegetables"),
                     omit.stat=c("LL","ser","f"),
                     se = list(df_coef_coa_1997[,2],df_coef_coa_2002[,2],df_coef_coa_2007[,2],df_coef_coa_2012[,2],df_coef_coa_2017[,2]),
                     p=list(df_coef_coa_1997[,5],df_coef_coa_2002[,5],df_coef_coa_2007[,5],df_coef_coa_2012[,5],df_coef_coa_2017[,5]),
                     column.labels=c("1997", "2002", "2007", "2012", "2017"), model.numbers=FALSE)

```

 
## Create Model Versions with Only Percent Cropland and Percent Cropland & Cropland Diversity

```{r}

#Based off natural dataset so easier to compare results
data_pcrop<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% #8939 observations (match crops_3yrs and diversity)
  select(FIPS, Year, ASDCode, ERSCode,insect_planted, pland_crops) %>% 
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=pland_crops)

lm_pcrop<-lm(Insecticide~PercentCrop+factor(Year)+factor(ASDCode), data=data_pcrop)
df_coef_pcrop<-lm_pcrop%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_pcrop$ASDCode, test = "Satterthwaite")
stargazer::stargazer(lm_pcrop, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/simple/pcrop_stargazer.txt",
                               covariate.labels=c("Percent Cropland"),
                     omit.stat=c("LL","ser","f"),se = list(df_coef_pcrop[,2]),p=list(df_coef_pcrop[,5]))
#not as good of a model, R2 only .6 compared to ~.7 or higher in other final models



#Based off natural dataset so easier to compare results
data_pcrop_cdl<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
    filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% #8939 observations (match crops_3yrs and diversity)
  select(FIPS, Year, ASDCode, ERSCode,insect_planted, pland_crops, SDI) %>% 
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=pland_crops,
         CropDiversity=SDI)

lm_pcrop_cdl<-lm(Insecticide~PercentCrop+CropDiversity+factor(Year)+factor(ASDCode), data=data_pcrop_cdl)
df_coef_pcrop_cdl<-lm_pcrop_cdl%>% clubSandwich::coef_test(vcov = "CR2", cluster = data_pcrop_cdl$ASDCode, test = "Satterthwaite")
stargazer::stargazer(lm_pcrop_cdl, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/simple/pcrop_cdl_stargazer.txt",
                               covariate.labels=c("Percent Cropland", "Cropland Diversity"),
                     omit.stat=c("LL","ser","f"),se = list(df_coef_pcrop_cdl[,2]),p=list(df_coef_pcrop_cdl[,5]))
#not as good of a model, R2 only .6 compared to ~.7 or higher in other final models; better than just cropland but not as good

```


## Attempt adding in Percent_Natural

```{r}

load("Data/DataProcessing/df/fulldata.rda")

data_plandnatural<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, pland_natural, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
  filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% 
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
  rename(Insecticide=insect_planted,
         PercentCrop=pland_crops,
         PercentNatural=pland_natural,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi,
         CropDiversity=SDI)
lm_plandnatural<-lm(Insecticide~PercentCrop+PercentNatural+LargeFarms+
                         SoyGrains+Corn+FruitVeg+LandDiversity+CropDiversity+
                         factor(Year)+factor(ASDCode), data=data_plandnatural)
stargazer::stargazer(lm_plandnatural, type="text", omit=c("ASDCode","Year"), 
                     out="Data/Visualize/plandnatural/plandnatural.txt")

data_correlation<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode,
         insect_planted, pland_crops, pland_natural, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         msidi, SDI) %>% 
  filter(!Year==2002)%>% #Only 3 years of data
  na.omit() %>% #8939 observations (match crops_3yrs and diversity)
  rename(Insecticide=insect_planted) %>% 
  mutate(PercentCrop=pland_crops-ave(pland_crops, Year)-ave(pland_crops, ASDCode),
         PercentNatural=pland_natural-ave(pland_natural, Year)-ave(pland_natural, ASDCode),
         LargeFarms=largefarm_planted-ave(largefarm_planted, Year)-ave(largefarm_planted, ASDCode),
         SoyGrains=soysmallgrain_planted-ave(soysmallgrain_planted, Year)-ave(soysmallgrain_planted, ASDCode),
         Corn=corn_planted-ave(corn_planted, Year)-ave(corn_planted, ASDCode),
         FruitVeg=fruitveg_planted-ave(fruitveg_planted, Year)-ave(fruitveg_planted, ASDCode),
         LandDiversity=msidi-ave(msidi, Year)-ave(msidi, ASDCode),
         CropDiversity=SDI-ave(SDI, Year)-ave(SDI, ASDCode)) %>% 
  select(PercentCrop, PercentNatural, LargeFarms, SoyGrains, Corn, FruitVeg, LandDiversity, CropDiversity)

png(filename="Data/Visualize/plandnatural/corrplot.png",width=600, height=600)
corrplot::corrplot(cor(data_correlation), type = "upper", order = "hclust", 
                   tl.col = "black", tl.srt = 45,col=brewer.pal(n=8, name="RdYlBu"))
dev.off()

vif_data<-rownames_to_column(as.data.frame(car::vif(lm_plandnatural)), "term")
write_csv(vif_data, "Data/Visualize/plandnatural/vif.csv")

df_coef_plandnatural<-lm_plandnatural %>% 
  clubSandwich::coef_test(vcov = "CR2", cluster = data_plandnatural$ASDCode, test = "Satterthwaite") %>% 
  tibble::rownames_to_column(var = "term") %>% 
  rename(estimate=beta, std.error=SE, statistic=tstat, p.value=p_Satt) %>% 
  dplyr::filter(!stringr::str_detect(term, "(Intercept)"),
                !stringr::str_detect(term, "factor"))


#Plot diversity on x and coefficient on y with SD facet by term
#Relabel predictors
plandnatural_plot_df <- df_coef_plandnatural %>%
  dotwhisker::relabel_predictors(c(PercentCrop = "Percent Cropland",
                       PercentNatural = "Percent Natural Area",
                       LargeFarms = " Proportion Large Farm",
                       SoyGrains= "Proportion Soy & Grains",
                       Corn= "Proportion Corn",
                       FruitVeg= "Proportion Fruit & Veg",
                       LandDiversity= "Landscape Diversity",
                       CropDiversity="Cropland Diversity"))

plandnatural_compare<-ggplot2::ggplot(plandnatural_plot_df, aes(y=fct_rev(as_factor(term)))) +
  geom_errorbarh(aes(xmax = estimate + (1.96*std.error), xmin = estimate - (1.96*std.error)),
                height=0.3, size=1, colour="royalblue")+
  geom_point(aes(x=estimate), size=2, colour="royalblue")+
  geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("")+xlab("Coefficient Estimate")+
  theme(text = element_text(size = 20))

  ggexport(plandnatural_compare, filename = "Data/Visualize/plandnatural/plandnatural.png",
           width = 900, height = 800)


```


##Create models comparison 
Of census variables +naturalcropedge, and NLCD variables +natural crop edge
Aka switching %crop and large farms from COA with % crop and avergae patch size NLCD,
With and without crop versions
No diversity
Currently no CRSE

```{r}

load("Data/DataProcessing/df/fulldata.rda")
#For 4 years of data

data_surrogates<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode, 
         insect_planted, pland_crops, harv_county, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted) %>% 
  na.omit() %>% #11924 observations (same as data_natural)
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         HarvestedCropland=harv_county,
         PercentCropland=pland_crops,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted)

#S for surrogates
#Census variables + natural crop edge, without crops
lm_s_coa_nocrops<-lm(Insecticide~HarvestedCropland+LargeFarms+NaturalCropEdge+factor(Year)+factor(ASDCode), data=data_surrogates)
#Census variables + natural crop edge, with crops
lm_s_coa_crops<-lm(Insecticide~HarvestedCropland+LargeFarms+
                  SoyGrains+Corn+FruitVeg+NaturalCropEdge+
                  factor(Year)+factor(ASDCode), data=data_surrogates)
#NLCD variables + natural crop edge, without crops
lm_s_nlcd_nocrops<-lm(Insecticide~PercentCropland+MeanCropArea+NaturalCropEdge+factor(Year)+factor(ASDCode), data=data_surrogates)
#NLCD variables + natural crop edge, with crops
lm_s_nlcd_crops<-lm(Insecticide~PercentCropland+MeanCropArea+
                  SoyGrains+Corn+FruitVeg+NaturalCropEdge+
                  factor(Year)+factor(ASDCode), data=data_surrogates)

#Create stargazer table
stargazer::stargazer(lm_s_coa_nocrops, lm_s_coa_crops, lm_s_nlcd_nocrops, lm_s_nlcd_crops, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/surrogates/surrogate_model_compare.txt",
                     omit.stat=c("LL","ser","f"),
                    column.labels=c("CoA", "CoA w/Crops", "NLCD", "NLCD w/Crops"), model.numbers=FALSE)

#Get AIC and R2 values
#lm_s_coa_nocrops
lm_s_coa_nocrops_r2<-summary(lm_s_coa_nocrops)$r.squared
lm_s_coa_nocrops_adjr2<-summary(lm_s_coa_nocrops)$adj.r.squared
lm_s_coa_nocrops_AIC<-stats::AIC(lm_s_coa_nocrops)

#lm_s_coa_crops
lm_s_coa_crops_r2<-summary(lm_s_coa_crops)$r.squared
lm_s_coa_crops_adjr2<-summary(lm_s_coa_crops)$adj.r.squared
lm_s_coa_crops_AIC<-stats::AIC(lm_s_coa_crops)

#lm_s_nlcd_nocrops
lm_s_nlcd_nocrops_r2<-summary(lm_s_nlcd_nocrops)$r.squared
lm_s_nlcd_nocrops_adjr2<-summary(lm_s_nlcd_nocrops)$adj.r.squared
lm_s_nlcd_nocrops_AIC<-stats::AIC(lm_s_nlcd_nocrops)

#lm_s_nlcd_crops
lm_s_nlcd_crops_r2<-summary(lm_s_nlcd_crops)$r.squared
lm_s_nlcd_crops_adjr2<-summary(lm_s_nlcd_crops)$adj.r.squared
lm_s_nlcd_crops_AIC<-stats::AIC(lm_s_nlcd_crops)

```


#Try one more model real quick

```{r}

load("Data/DataProcessing/df/fulldata.rda")
#For 4 years of data

data_combine<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode, 
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted, msidi) %>% 
  na.omit() %>% #11924 observations (same as data_natural)
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCropland=pland_crops,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi)

#Testing combinations
#4 years
lm_combine_largefarm<-lm(Insecticide~PercentCropland+LargeFarms+NaturalCropEdge+
                        SoyGrains+Corn+FruitVeg+
                       LandDiversity+factor(Year)+factor(ASDCode), data=data_combine)
lm_combine_meancroparea<-lm(Insecticide~PercentCropland+MeanCropArea+NaturalCropEdge+
                        SoyGrains+Corn+FruitVeg+
                       LandDiversity+factor(Year)+factor(ASDCode), data=data_combine)

#lm_combine_largefarm
lm_combine_largefarm_r2<-summary(lm_combine_largefarm)$r.squared
lm_combine_largefarm_adjr2<-summary(lm_combine_largefarm)$adj.r.squared
lm_combine_largefarm_AIC<-stats::AIC(lm_combine_largefarm)

#lm_crops_3yrs
lm_combine_meancroparea_r2<-summary(lm_combine_meancroparea)$r.squared
lm_combine_meancroparea_adjr2<-summary(lm_combine_meancroparea)$adj.r.squared
lm_combine_meancroparea_AIC<-stats::AIC(lm_combine_meancroparea)

#Create stargazer table
stargazer::stargazer(lm_combine_largefarm, lm_combine_meancroparea, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/surrogates/combine_model_compare.txt",
                     omit.stat=c("LL","ser","f"))

```


#Improve current best R2 model

```{r}

load("Data/DataProcessing/df/fulldata.rda")

data_test<-fulldata %>% 
  select(FIPS, Year, ASDCode, ERSCode, harv_county,
         insect_planted, pland_crops, natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted, ed_crops,
         msidi) %>% 
  filter(harv_county>=0.01) %>% 
  na.omit() %>% #11088 observations 
  mutate_at(scale, .vars=vars(-FIPS, -Year, -ERSCode, -ASDCode, -insect_planted)) %>%  #Scale by subtracting column mean and dividing by column SD
    rename(Insecticide=insect_planted,
         PercentCrop=pland_crops,
         NaturalCropEdge=natural_crops_ed,
         MeanCropArea=mna_crops,
         LargeFarms=largefarm_planted,
         SoyGrains=soysmallgrain_planted,
         Corn=corn_planted,
         FruitVeg=fruitveg_planted,
         LandDiversity=msidi)



data_corr<-data_test %>% 
  mutate(PercentCrop=residuals(lm(PercentCrop~factor(ASDCode)+factor(Year), data=data_test)),
         NaturalCropEdge=residuals(lm(NaturalCropEdge~factor(ASDCode)+factor(Year), data=data_test)),
         MeanCropArea=residuals(lm(MeanCropArea~factor(ASDCode)+factor(Year), data=data_test)),
         LargeFarms=residuals(lm(LargeFarms~factor(ASDCode)+factor(Year), data=data_test)),
         SoyGrains=residuals(lm(SoyGrains~factor(ASDCode)+factor(Year), data=data_test)),
         Corn=residuals(lm(Corn~factor(ASDCode)+factor(Year), data=data_test)),
         FruitVeg=residuals(lm(FruitVeg~factor(ASDCode)+factor(Year), data=data_test)),
         LandDiversity=residuals(lm(LandDiversity~factor(ASDCode)+factor(Year), data=data_test)))%>% 
  select(PercentCrop, NaturalCropEdge, MeanCropArea, LargeFarms, SoyGrains, Corn, FruitVeg, LandDiversity)

#Using this site as basis:https://stackoverflow.com/questions/27431735/demeaning-data-on-multiple-levels-in-r

# png(filename="Data/Visualize/VIF/residuals_corrplot.png",width=600, height=600)
corrplot::corrplot(cor(data_corr), type = "upper", order = "hclust", 
          tl.col = "black", tl.srt = 45,col=brewer.pal(n=8, name="RdYlBu"))
# dev.off()

lm_test<-lm(Insecticide~PercentCrop+NaturalCropEdge+LargeFarms+SoyGrains+Corn+FruitVeg+LandDiversity+
                  factor(Year)+factor(ASDCode), data=data_test)
car::vif(lm_test) #NaturalCropEdge decreases VIF correlation by a lot, even if ed_crops had barely higher AIC/R2
summary(lm_test)$r.squared
summary(lm_test)$adj.r.squared
stats::AIC(lm_test)
stats::nobs(lm_test)
#Land Diversity not to crazy correlated
#Create stargazer table
stargazer::stargazer(lm_test, type="text", omit=c("ASDCode","Year"),
                     out="Data/Visualize/surrogates/test.txt",
                     omit.stat=c("LL","ser","f"))
```

Current model
PercentCrop       10.738670   1        3.276991
NaturalCropEdge    5.556705   1        2.357266
LargeFarms         6.415514   1        2.532886
SoyGrains          6.182497   1        2.486463
Corn               8.122319   1        2.849968
FruitVeg           3.126279   1        1.768129
LandDiversity      3.878896   1        1.969491
factor(Year)       1.072156   3        1.011680
factor(ASDCode) 2297.640478 300        1.012983
[1] 0.7417238
[1] 0.7342945
[1] -18659.18
[1] 11088


Current best model, variables above with 4 years and removing harv_county <1% (removing LandDiversity doesnt change much and improves correlation)
Adding mean crop area only makes it slightly worse; removing makes model slightly worse but variables individually more significant

Large Farms better than Mean Crop Area, but they are very comparable- slightly better VIF, AIC, R2, but very close values
If don't have large farms, kind of need crop covariates, and vice versa- the model isn't as good when all CoA removed, but is possible and not too bad
Honesty Land Diversity less important than LargeFarms



Scores to beat:ed_crops instead of naturalcropedge with meancroparea nad large farms but no because correlation
[1] 0.7418103
[1] 0.7343589
[1] -18660.89
[1] 11088

Large Farms and Crop Covariates and low correlation
[1] 0.741647
[1] 0.7342402
[1] -18657.88
[1] 11088

original test version, or removal of mean crop area (slightly higher but similar); mean crop area not as good as large farms, but not bad (percent cropland better than harv_county by a bit)
[1] 0.7417296
[1] 0.7342758
[1] -18657.43
[1] 11088

[1] 0.7417238
[1] 0.7342945
[1] -18659.18
[1] 11088

Not too shabby without crop covariates: and using no CoA except insecticides; but crop covariates majorly improve
[1] 0.6697154
[1] 0.6603094
[1] -15938.36
[1] 11088

##Make table of different AIC and R2 values from different models
However, there is one main difference between R2 and the adjusted R2: R2 assumes that every single variable explains the variation in the dependent variable. The adjusted R2 tells you the percentage of variation explained by only the independent variables that actually affect the dependent variable.

```{r}

#Load all models from models folder
load("Data/Analysis/models/lm_nocrops_4yrs.Rda")
load("Data/Analysis/models/lm_nocrops_3yrs.Rda")
load("Data/Analysis/models/lm_crops_4yrs.Rda")
load("Data/Analysis/models/lm_crops_3yrs.Rda")
load("Data/Analysis/models/lm_diversity.Rda")
load("Data/Analysis/models/lm_natural.Rda")
load("Data/Analysis/models/lm_forest.Rda")
load("Data/Analysis/models/lm_shrubgrass.Rda")
load("Data/Analysis/models/lm_regional.Rda")

#Make sure the following models are loaded from above: lm_pcrop_less1pc,lm_coa_cropless1pc,lm_harvcrop_comb, lm_pcrop, lm_prcop_cdl, lm_plandnatural
#Also taking AIc and R2 values from surrogate models run above: lm_s_coa_nocrops,lm_s_coa_crops,lm_s_nlcd_nocrops,lm_s_nlcd_crops


#Get R2 value and AIC from every model above (get both)
#lm_nocrops_4yrs
lm_nocrops_4yrs_r2<-summary(lm_nocrops_4yrs)$r.squared
lm_nocrops_4yrs_adjr2<-summary(lm_nocrops_4yrs)$adj.r.squared
lm_nocrops_4yrs_AIC<-stats::AIC(lm_nocrops_4yrs)

#lm_nocrops_3yrs
lm_nocrops_3yrs_r2<-summary(lm_nocrops_3yrs)$r.squared
lm_nocrops_3yrs_adjr2<-summary(lm_nocrops_3yrs)$adj.r.squared
lm_nocrops_3yrs_AIC<-stats::AIC(lm_nocrops_3yrs)

#lm_crops_4yrs
lm_crops_4yrs_r2<-summary(lm_crops_4yrs)$r.squared
lm_crops_4yrs_adjr2<-summary(lm_crops_4yrs)$adj.r.squared
lm_crops_4yrs_AIC<-stats::AIC(lm_crops_4yrs)

#lm_crops_3yrs
lm_crops_3yrs_r2<-summary(lm_crops_3yrs)$r.squared
lm_crops_3yrs_adjr2<-summary(lm_crops_3yrs)$adj.r.squared
lm_crops_3yrs_AIC<-stats::AIC(lm_crops_3yrs)

#lm_diversity
lm_diversity_r2<-summary(lm_diversity)$r.squared
lm_diversity_adjr2<-summary(lm_diversity)$adj.r.squared
lm_diversity_AIC<-stats::AIC(lm_diversity)

#lm_natural
lm_natural_r2<-summary(lm_natural)$r.squared
lm_natural_adjr2<-summary(lm_natural)$adj.r.squared
lm_natural_AIC<-stats::AIC(lm_natural)

#lm_forest
lm_forest_r2<-summary(lm_forest)$r.squared
lm_forest_adjr2<-summary(lm_forest)$adj.r.squared
lm_forest_AIC<-stats::AIC(lm_forest)

#lm_shrubgrass
lm_shrubgrass_r2<-summary(lm_shrubgrass)$r.squared
lm_shrubgrass_adjr2<-summary(lm_shrubgrass)$adj.r.squared
lm_shrubgrass_AIC<-stats::AIC(lm_shrubgrass)

#lm_regional
lm_regional_r2<-summary(lm_regional)$r.squared
lm_regional_adjr2<-summary(lm_regional)$adj.r.squared
lm_regional_AIC<-stats::AIC(lm_regional)

#lm_pcrop_less1pc
lm_pcrop_less1pc_r2<-summary(lm_pcrop_less1pc)$r.squared
lm_pcrop_less1pc_adjr2<-summary(lm_pcrop_less1pc)$adj.r.squared
lm_pcrop_less1pc_AIC<-stats::AIC(lm_pcrop_less1pc)

#lm_coa_cropless1pc
lm_coa_cropless1pc_r2<-summary(lm_coa_cropless1pc)$r.squared
lm_coa_cropless1pc_adjr2<-summary(lm_coa_cropless1pc)$adj.r.squared
lm_coa_cropless1pc_AIC<-stats::AIC(lm_coa_cropless1pc)

#lm_harvcrop_comb
lm_harvcrop_comb_r2<-summary(lm_harvcrop_comb)$r.squared
lm_harvcrop_comb_adjr2<-summary(lm_harvcrop_comb)$adj.r.squared
lm_harvcrop_comb_AIC<-stats::AIC(lm_harvcrop_comb)

#lm_pcrop
lm_pcrop_r2<-summary(lm_pcrop)$r.squared
lm_pcrop_adjr2<-summary(lm_pcrop)$adj.r.squared
lm_pcrop_AIC<-stats::AIC(lm_pcrop)

#lm_prcop_cdl
lm_pcrop_cdl_r2<-summary(lm_pcrop_cdl)$r.squared
lm_pcrop_cdl_adjr2<-summary(lm_pcrop_cdl)$adj.r.squared
lm_pcrop_cdl_AIC<-stats::AIC(lm_pcrop_cdl)

#lm_plandnatural
lm_plandnatural_r2<-summary(lm_plandnatural)$r.squared
lm_plandnatural_adjr2<-summary(lm_plandnatural)$adj.r.squared
lm_plandnatural_AIC<-stats::AIC(lm_plandnatural)

#Deciding to extract #observations from each so AIC more comparable
lm_nocrops_4yrs_nobs<-nobs(lm_nocrops_4yrs)
lm_nocrops_3yrs_nobs<-nobs(lm_nocrops_3yrs)
lm_crops_4yrs_nobs<-nobs(lm_crops_4yrs)
lm_crops_3yrs_nobs<-nobs(lm_crops_3yrs)
lm_diversity_nobs<-nobs(lm_diversity)
lm_natural_nobs<-nobs(lm_natural)
lm_forest_nobs<-nobs(lm_forest)
lm_shrubgrass_nobs<-nobs(lm_shrubgrass)
lm_regional_nobs<-nobs(lm_regional)
lm_pcrop_less1pc_nobs<-nobs(lm_pcrop_less1pc)
lm_coa_cropless1pc_nobs<-nobs(lm_coa_cropless1pc)
lm_harvcrop_comb_nobs<-nobs(lm_harvcrop_comb)
lm_pcrop_nobs<-nobs(lm_pcrop)
lm_pcrop_cdl_nobs<-nobs(lm_pcrop_cdl)
lm_plandnatural_nobs<-nobs(lm_plandnatural)
lm_s_coa_nocrops_nobs<-nobs(lm_s_coa_nocrops)
lm_s_coa_crops_nobs<-nobs(lm_s_coa_crops)
lm_s_nlcd_nocrops_nobs<-nobs(lm_s_nlcd_nocrops)
lm_s_nlcd_crops_nobs<-nobs(lm_s_nlcd_crops)
lm_combine_largefarm_nobs<-nobs(lm_combine_largefarm)
lm_combine_meancroparea_nobs<-nobs(lm_combine_meancroparea)



#Model Names
modelnames<-c("lm_nocrops_4yrs","lm_nocrops_3yrs","lm_crops_4yrs","lm_crops_3yrs","lm_diversity","lm_natural","lm_forest","lm_shrubgrass","lm_regional", "lm_pcrop_less1pc","lm_coa_cropless1pc","lm_harvcrop_comb", "lm_pcrop", "lm_pcrop_cdl", "lm_plandnatural","lm_s_coa_nocrops","lm_s_coa_crops","lm_s_nlcd_nocrops","lm_s_nlcd_crops", "lm_combine_largefarm", "lm_combine_meancroparea")

#Combine values into table
model_stats<-data.frame(modelnames)

#R2
model_stats$r2<-c(lm_nocrops_4yrs_r2,lm_nocrops_3yrs_r2,lm_crops_4yrs_r2,lm_crops_3yrs_r2,lm_diversity_r2,lm_natural_r2,lm_forest_r2,lm_shrubgrass_r2,lm_regional_r2, lm_pcrop_less1pc_r2,lm_coa_cropless1pc_r2,lm_harvcrop_comb_r2, lm_pcrop_r2, lm_pcrop_cdl_r2, lm_plandnatural_r2,lm_s_coa_nocrops_r2,lm_s_coa_crops_r2,lm_s_nlcd_nocrops_r2,lm_s_nlcd_crops_r2,lm_combine_largefarm_r2, lm_combine_meancroparea_r2)

#Adjusted R2
model_stats$adjr2<-c(lm_nocrops_4yrs_adjr2,lm_nocrops_3yrs_adjr2,lm_crops_4yrs_adjr2,lm_crops_3yrs_adjr2,lm_diversity_adjr2,lm_natural_adjr2,lm_forest_adjr2,lm_shrubgrass_adjr2,lm_regional_adjr2, lm_pcrop_less1pc_adjr2,lm_coa_cropless1pc_adjr2,lm_harvcrop_comb_adjr2, lm_pcrop_adjr2, lm_pcrop_cdl_adjr2, lm_plandnatural_adjr2,lm_s_coa_nocrops_adjr2,lm_s_coa_crops_adjr2,lm_s_nlcd_nocrops_adjr2,lm_s_nlcd_crops_adjr2,lm_combine_largefarm_adjr2, lm_combine_meancroparea_adjr2)

#AIC
model_stats$AIC<-c(lm_nocrops_4yrs_AIC,lm_nocrops_3yrs_AIC,lm_crops_4yrs_AIC,lm_crops_3yrs_AIC,lm_diversity_AIC,lm_natural_AIC,lm_forest_AIC,lm_shrubgrass_AIC,lm_regional_AIC, lm_pcrop_less1pc_AIC,lm_coa_cropless1pc_AIC,lm_harvcrop_comb_AIC, lm_pcrop_AIC, lm_pcrop_cdl_AIC, lm_plandnatural_AIC,lm_s_coa_nocrops_AIC,lm_s_coa_crops_AIC,lm_s_nlcd_nocrops_AIC,lm_s_nlcd_crops_AIC,lm_combine_largefarm_AIC, lm_combine_meancroparea_AIC)

#Number of Observations
model_stats$nobs<-c(lm_nocrops_4yrs_nobs,lm_nocrops_3yrs_nobs,lm_crops_4yrs_nobs,lm_crops_3yrs_nobs,lm_diversity_nobs,lm_natural_nobs,lm_forest_nobs,lm_shrubgrass_nobs,lm_regional_nobs, lm_pcrop_less1pc_nobs,lm_coa_cropless1pc_nobs,lm_harvcrop_comb_nobs, lm_pcrop_nobs, lm_pcrop_cdl_nobs, lm_plandnatural_nobs,lm_s_coa_nocrops_nobs,lm_s_coa_crops_nobs,lm_s_nlcd_nocrops_nobs,lm_s_nlcd_crops_nobs,lm_combine_largefarm_nobs, lm_combine_meancroparea_nobs)

nr<-nrow(model_stats)
msdf<-model_stats %>% 
  arrange(AIC) %>% 
  mutate(AICorder=1:nr) %>% 
  arrange(-r2) %>% 
  mutate(r2order=1:nr) %>% 
  arrange(-adjr2) %>% 
  mutate(adjr2order=1:nr) %>% 
  arrange(-nobs)



```

"https://stats.stackexchange.com/questions/140965/when-aic-and-adjusted-r2-lead-to-different-conclusions/342734"
R2  and AIC are answering two different questions. I want to keep this breezy and non-mathematical, so my statements are non-mathematical. R2 is saying something to the effect of how well your model explains the observed data. If the model is regression and non-adjusted R^2 is used, then this is correct on the nose.
AIC, on the other hand, is trying to explain how well the model will predict on new data. That is, AIC is a measure of how well the model will fit new data, not the existing data. Lower AIC means that a model should have improved prediction.
Frequently adding more variables decreases predictive accuracy and in that case the model with higher R2 will have a higher (worse) AIC. A nice example of this is in "Introduction to Statistical Learning with R" in the chapter on regression models including 'best subset' and regularization. They do a pretty thorough analysis of the 'hitters' data set. One can also do a thought experiment. Imagine one is trying to predict output on the basis of some known variables. Adding noise variables to the fit will increase R^2, but it will also decrease predictive power of the model. Thus the model with noise variables will have higher R2 and higher AIC.


