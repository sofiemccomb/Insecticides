---
title: "Visualize"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown will be used to visualize the data and results developed from the Analysis.Rmd.


### Load Packages

```{r packages, message=F, warning=F}

#Load the needed packages (install first if necessary)
library(ggplot2) #data visualization
library(ggpubr)#To arrange ggplots on a page
library(stringr)#String detection
library(tidyverse) #Datatable manipulation (all functions)
library(dotwhisker) #Box and whisker plots
library(forestplot)
# library(stargazer)#regression and summary statistics tables

#Set options
  #options(scipen=999) #no scientific notation (all)

```

### Load Data

Data was cleaned up using the broom package.
More information on the package and the format of the data can be found at: 
https://cran.r-project.org/web/packages/broom/vignettes/broom.html

Using clubsandwih package to perform cluster-robust standard errors in tidy format.
For more information: https://cran.r-project.org/web/packages/clubSandwich/vignettes/panel-data-CRVE.html

```{r data, message=FALSE, warning=FALSE}

#Load data for cp and ERS df with cluster-robust standard errors
cp_df_coef<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest.csv")
ERS_df_coef<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest.csv")

#Load fulldata
load("Data/DataProcessing/df/fulldata.rda")

```


### Boxplots of time trends of covariates

Creating boxplots showing the values for each of the variables being considered in any of the regression models, across the years being considered. Using the fulldata datasets (loaded in the variable_boxplots.R script sourced below).


```{r var boxplots, message=F, warning=F}

#Source R script to create boxplot visualizations
source("R/Visualize/variable_boxplots.R")

#Create boxplots for variables of interest (NA values will be removed)
insect_plot<-var_boxplot(variable=fulldata$insect_planted, yaxis="Prop. Cropland w/ Insecticides")
plandcrops_plot<-var_boxplot(variable=fulldata$pland_crops, yaxis="Prop. of Cty in Cropland")
cropintensity_plot<-var_boxplot(variable=fulldata$cropintensity, yaxis="Cropland Intensity")
msidi_plot<-var_boxplot(variable=fulldata$msidi, yaxis="Landscape Diversity")
mnacrops_plot<-var_boxplot(variable=fulldata$mna_crops, yaxis="Avg. Acreage of Crop Patches")
largefarm_plot<-var_boxplot(variable=fulldata$largefarm_planted, yaxis="Prop. of Cropland with Lg. Farms")
ncshared_plot<-var_boxplot(variable=fulldata$te_shared_c_nc, yaxis="Natural to Crop Land Edges")
SDI_plot<-var_boxplot(variable=fulldata$SDI, yaxis="Crop Diversity")
soygrain_plot<-var_boxplot(variable=fulldata$soysmallgrain_planted, yaxis="Prop. Soybeans & Sm. Grains")
corn_plot<-var_boxplot(variable=fulldata$corn_planted, yaxis="Prop. Corn")
fruitveg_plot<-var_boxplot(variable=fulldata$fruitveg_planted, yaxis="Prop. Fruit & Veg.")

#Arrange boxplots on one page
allvarplots<-ggarrange(insect_plot, plandcrops_plot, cropintensity_plot,
             msidi_plot, mnacrops_plot, largefarm_plot, 
             ncshared_plot, SDI_plot, 
             soygrain_plot, corn_plot, fruitveg_plot, 
          labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"),
          ncol = 4, nrow = 3)

#Save the combined variable boxplots page
ggexport(allvarplots, filename = "Data/Visualize/boxplots/allvariables_trends_boxplots.png",
          width = 1800, height = 1500)

```


#Box and Whisker Plots

Create box and whisker plots of the model coefficients useing the dotwhisker package.

```{r}

#Create box and whisker plots

#Using the twoways only for visualizations currently

#CP
#Relabel predictors
cp_plot_df <- cp_df_coef %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     CropIntensity = "Crop Intensity",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Can simply using dwplot function to create boxwhisker plot
cp_plot1<-dotwhisker::dwplot(cp_plot_df,
                             dot_args = list(size = 2),
                            whisker_args = list(size = 0.5))+
   theme_bw() + xlab("Coefficient Estimate") + ylab("") +
     geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
     ggtitle("Coefficient Comparison for Counties Pooled") +
     theme(plot.title = element_text(face="bold", size=20),
           legend.title = element_blank(),
           legend.text = element_text(size=16),
           axis.text=element_text(size=14),
           axis.title = element_text(size=16))

ggexport(cp_plot1, filename = "Data/Visualize/boxwhisker/cp_twoways_crse_compare.png",
          width = 1200, height = 800)
 
#Generate a 'small multiple' plot of cp coefficients
cp_plot2<-dotwhisker::small_multiple(cp_plot_df,
                                     dot_args = list(size = 1.0),
                                     whisker_args = list(size = 0.5)) +
  theme_bw() + ylab("Coefficient Estimate") +
  geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  ggtitle("Coefficient Comparison for Counties Pooled") +
  theme(text = element_text(size = 14),
        plot.title = element_text(face = "bold", size=20), 
        legend.position = "none",
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.text=element_text(size=12),
        axis.title = element_text(size=18)) 

ggexport(cp_plot2, filename = "Data/Visualize/boxwhisker/cp_twoways_crse_multicompare.png",
          width = 2100, height = 1500)


#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
CPcompare<-ggplot(cp_plot_df, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare, filename = "Data/Visualize/boxwhisker/CPcompare.png",
             width = 1500, height = 1200)

#ERS
#Relabel predictors
ERS_plot_df <- ERS_df_coef %>%
  relabel_predictors(c(PercentCrop = "% Crop",
                     CropIntensity = "Crop Intensity",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Create boxwhisker plot of all ERS models together
ERS_plot1<-dotwhisker::dwplot(ERS_plot_df,
                              dot_args = list(size = 1.4),
                              whisker_args = list(size = 0.5))+
     theme_bw() + xlab("Coefficient Estimate") + ylab("") +
     geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
     ggtitle("Coefficient Comparison for ERS") +
     theme(plot.title = element_text(face="bold", size=20),
           legend.title = element_blank(),
           legend.text = element_text(size=16),
           axis.text=element_text(size=14),
           axis.title = element_text(size=16))

ggexport(ERS_plot1, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_compare.png",
          width = 1200, height = 800)


#For some reason small_multiple and submodels do not work
  #So will subset by ERS and send through small_multiple

ERS<-1:9 #9 ERS Regions
  for (e in ERS){
    ERS_plot_df_subset<-subset(ERS_plot_df, ERS_plot_df$ERS==e)
    
    ERS_plot2<-dotwhisker::small_multiple(ERS_plot_df_subset,
                                          dot_args = list(size = 1.0),
                                          whisker_args = list(size = 0.5)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            legend.position = "none",
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18))  

    ggexport(ERS_plot2, filename = paste0("Data/Visualize/boxwhisker/ERS_twoways_crse_multicompare_ERS", e, ".png"),
             width = 2100, height = 1500)
    
  }#End ERS Loop


#Create boxwhisker plot where ERS column called model
ERS_plot_df_byERS<-ERS_plot_df %>% 
  rename(plm=model,
         model=ERS)
ERS_plot3<-dotwhisker::dwplot(ERS_plot_df_byERS,
                              dot_args = list(size = 1.4),
                              whisker_args = list(size = 0.5))+
     theme_bw() + xlab("Coefficient Estimate") + ylab("") +
     geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
     ggtitle("Coefficient Comparison for ERS") +
     theme(plot.title = element_text(face="bold", size=20),
           legend.title = element_blank(),
           legend.text = element_text(size=16),
           axis.text=element_text(size=14),
           axis.title = element_text(size=16)) 

ggexport(ERS_plot3, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_compare_byERS.png",
             width = 1200, height = 800)


```


Figure out way to put similar ERS region results together (panel of 4 with two together- such as NW, SW, NE, SE, Midwest, etc.)

```{r}

#Trying submodels again


ERS_plot_df_sub <- ERS_df_coef %>%
  rename(submodel = ERS) %>%
  select(-submodel, everything(), submodel) %>%
  relabel_predictors(c(pland_crops = "% Crop",
                     cropintensity = "Crop Intensity",
                     msidi = "Land Diversity",
                     mna_crops = "Avg. Crop Area",
                     largefarm_planted = "Large Farm",
                     natural_crops_ed = "Natural-Crop Edge",
                     SDI= "Crop Diversity",
                     soysmallgrain_planted= "Soy & Grains",
                     corn_planted= "Corn",
                     fruitveg_planted= "Fruit & Veg"))

#Subset by ERS to graph together as submodels (max of 3 and need 0 and 1)
  ERS_west<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==3|ERS_plot_df_sub$submodel==8)
  ERS_west[ERS_west == 3] <- 1 #Northern Great Plains
  ERS_west[ERS_west == 8] <- 0 #Basin and Range
  
  ERS_midwest<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==1|ERS_plot_df_sub$submodel==4)
  #ERS_midwest[ERS_midwest == 1] <- 1 #Heartland
  ERS_midwest[ERS_midwest == 4] <- 0 #Prairie Gateway
  
  ERS_southeast<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==6|ERS_plot_df_sub$submodel==9)
  ERS_southeast[ERS_southeast == 6] <- 1 #Southern Seaboard
  ERS_southeast[ERS_southeast == 9] <- 0 #Mississippi Portal
  
  ERS_northeast<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==2|ERS_plot_df_sub$submodel==5)
  ERS_northeast[ERS_northeast == 2] <- 1 #Northern Crescent
  ERS_northeast[ERS_northeast == 5] <- 0 #Eastern Uplands
  
  ERS_fruit<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==7)

#WEST
    ERS_plot_west<-dotwhisker::small_multiple(ERS_west,
                                          dot_args = list(size = 0.5),
                                          whisker_args = list(size = 0.3)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for Western ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18)) +
    scale_colour_hue(name = "ERS",
                     breaks = c(0, 1),
                     labels = c("Basin and Range", "Northern Great Plains"))
    ggexport(ERS_plot_west, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_west.png",
             width = 1500, height = 1200)
 
#MIDWEST   
     ERS_plot_midwest<-dotwhisker::small_multiple(ERS_midwest,
                                          dot_args = list(size = 0.5),
                                          whisker_args = list(size = 0.3)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for Midwest ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18)) +
    scale_colour_hue(name = "ERS",
                     breaks = c(0, 1),
                     labels = c("Prairie Gateway", "Heartland"))
    ggexport(ERS_plot_midwest, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_midwest.png",
             width = 1500, height = 1200)
    
#Southeast
     ERS_plot_southeast<-dotwhisker::small_multiple(ERS_southeast,
                                          dot_args = list(size = 0.5),
                                          whisker_args = list(size = 0.3)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for Southeast ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18)) +
    scale_colour_hue(name = "ERS",
                     breaks = c(0, 1),
                     labels = c("Mississippi Portal", "Southern Seaboard"))
    ggexport(ERS_plot_southeast, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_southeast.png",
             width = 1500, height = 1200)
    
#Northeast
     ERS_plot_northeast<-dotwhisker::small_multiple(ERS_northeast,
                                          dot_args = list(size = 0.5),
                                          whisker_args = list(size = 0.3)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for Northeast ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18)) +
    scale_colour_hue(name = "ERS",
                     breaks = c(0, 1),
                     labels = c("Eastern Uplands", "Northern Cresecent"))
    ggexport(ERS_plot_northeast, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_northeast.png",
             width = 1500, height = 1200)
    
#Fruitful Rim
     ERS_plot_fruit<-dotwhisker::small_multiple(ERS_fruit,
                                          dot_args = list(size = 0.5),
                                          whisker_args = list(size = 0.3)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for Fruitful Rim ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18))+
        scale_colour_hue(name = "ERS",
                     breaks = c(7),
                     labels = c("Fruitful Rim"))
    ggexport(ERS_plot_fruit, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_fruit.png",
             width = 1500, height = 1200)
#Just make and save all 5 and then bind them in the PDF and give good title
    #Currrently too large to panel them
    
    #Also do it for regular dwplot and separate into regions- those can be stacked next to each easier

```


#Look at one variable across ERS for a model

```{r}

ERS_subset <- ERS_df_coef %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     CropIntensity = "Crop Intensity",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
ERScompare<-ggplot(ERS_subset, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare, filename = "Data/Visualize/boxwhisker/ERScompare.png",
             width = 1500, height = 1200)


```




### Tables of Final Models

Add to this section once final models are decided on. 
Will load and select final models from rda files, and then put together in a stargazer table.
Otherwise will just use kabletable on the created dataframes.

For example:

```{r stargazer, message=F, warning=F}


# panel_models_CDL_ERS_3var<-stargazer(countytime_model_CDL_ag1_3var, countytime_model_CDL_ag2_3var, countytime_model_CDL_ag3_3var, 
#                                      countytime_model_CDL_ag4_3var, countytime_model_CDL_ag5_3var, countytime_model_CDL_ag6_3var, 
#                                      countytime_model_CDL_ag7_3var, countytime_model_CDL_ag8_3var, countytime_model_CDL_ag9_3var,
#                                      type = "text", column.labels = c("Heartland", "Northern Crescent", "Northern Great Plains",
#                                                                       "Prairie Gateway", "Eastern Uplands", "Southern Seaboard",
#                                                                       "Fruitful Rim", "Basin and Range", "Mississippi Portal"),
#                                      out="Z:/Sofie/Data/Regressions/panel_models_CDL_EDS_3var.txt") 


```


### Examine spatially what variables look like per county/ERS region

Create map figure with the SD over time of each of the regression variables/covariates (color code of SD between the years)-instead of the all the year numbers

```{r}

#Need the shapefile- reading in from computer but eventually maybe store it on github
#Read in FIPS county shapefile
library(sf)
library(tidyverse)
#library(ggplot2)


counties<-read_sf(dsn = "C:/Users/shemc/Documents/UCSB/NLCD/Data/TIGER2018_Counties", layer = "tl_2018_us_county") %>%  
  dplyr::mutate(FIPS=paste0(STATEFP,COUNTYFP))
contig48_counties<-subset(counties,counties$STATEFP!="02"& counties$STATEFP!="15"&
                              counties$STATEFP!="60"&counties$STATEFP!="66"&
                              counties$STATEFP!="69"&counties$STATEFP!="72"&
                              counties$STATEFP!="74"&counties$STATEFP!="78") %>% 
  select(FIPS) %>% #only CONUS counties and just need FIPS
  dplyr::mutate(FIPS=as.numeric(FIPS))
#Load fulldata
load("Data/DataProcessing/df/fulldata.rda")
counties_data <- merge(contig48_counties, fulldata, by='FIPS') %>% 
  select(FIPS, Year, ERSCode, ASDCode, insect_planted, pland_crops, cropintensity, SDI,
         largefarm_planted, mna_crops, natural_crops_ed, msidi,
         soysmallgrain_planted, corn_planted, fruitveg_planted)

counties_sd<-counties_data %>% 
  group_by(FIPS) %>%
  summarize(insect_sd=sd(insect_planted, na.rm=TRUE),
            plandcrops_sd=sd(pland_crops, na.rm=TRUE),
            cropintensity_sd=sd(cropintensity, na.rm=TRUE),
            cropdiversity_sd=sd(SDI, na.rm=TRUE),
            largefarm_sd=sd(largefarm_planted, na.rm=TRUE),
            mnacrops_sd=sd(mna_crops, na.rm=TRUE),
            ncedge_sd=sd(natural_crops_ed, na.rm=TRUE),
            landdiversity_sd=sd(msidi, na.rm=TRUE),
            soygrain_sd=sd(soysmallgrain_planted, na.rm=TRUE),
            corn_sd=sd(corn_planted, na.rm=TRUE),
            fruitveg_sd=sd(fruitveg_planted, na.rm=TRUE))
            


#Calculate standard deviation over time of each term variable- for each FIPS calculate the SD- group by FIPS and calculate SD

library(tmap) #Takes awhile but would be more replicable
# tm_shape(counties_data) +
#   tm_fill("insect_planted", palette = "Spectral", breaks=c("0", "0.5", "1", "1.5", "2", "2.5", "3"))+
#   tm_borders(col = "gray60", lwd = 2)

tm_shape(counties_sd)+
  tm_fill("insect_sd", 
          title = "Insecticides",
          breaks = c(0, 0.25, 0.5, 0.75, 1),
          style = "fixed",
          textNA = "No data",
          colorNA = "white", 
          palette = "Reds")+
  tm_borders()


#Figure out how to:
 #Set coloring dimensions

```

