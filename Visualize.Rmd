---
title: "Visualize"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown will be used to visualize the data and results developed from the Analysis.Rmd.


### Load Packages

```{r packages, message=F, warning=F}

#Load the needed packages (install first if necessary)
library(ggplot2) #data visualization
library(ggpubr)#To arrange ggplots on a page
# library(tidyverse) #Datatable manipulation (all functions)
  # library(tools) #For file_path sans_ext (COA.R)
  # library(purrr) #For reduce function using full_join (COA.R)
  # library(zoo) #For na.locf function (COA.R)
  # library(janitor) #Clean colnames (CDL.R)
  # library(vegan) #Perform diversity calculation (CDL.R)
  # library(readxl) #read excel .xlsx (ERS data)


# library(stargazer)#regression and summary statistics tables
# library(plm) #linear models for panel data
# library(lmtest) #testing for linear regression models

#Set options
  #options(scipen=999) #no scientific notation (all)


library(forestplot)
library(tidyverse)

#Load data for coefficient and se values
cp_coef_df<-readr::read_csv("Data/Analysis/df/CP/cp_coef_df.csv")
cp_se_df<- readr::read_csv ("Data/Analysis/df/CP/cp_se_df.csv")

```


### Boxplots of time trends of covariates

Creating boxplots showing the values for each of the variables being considered in any of the regression models, across the years being considered. Using the fulldata datasets (loaded in the variable_boxplots.R script sourced below).


```{r var boxplots, message=F, warning=F}

#Source R script to create boxplot visualizations
source("R/Visualize/variable_boxplots.R")

#Create boxplots for variables of interest (NA values will be removed)
insect_plot<-var_boxplot(variable=fulldata$insect_planted, yaxis="Prop. Cropland w/ Insecticides")
plandcrops_plot<-var_boxplot(variable=fulldata$pland_crops, yaxis="Prop. of Cty in Cropland")
cropintensity_plot<-var_boxplot(variable=fulldata$cropintensity, yaxis="Cropland Intensity")
msidi_plot<-var_boxplot(variable=fulldata$msidi, yaxis="Landscape Diversity")
mnacrops_plot<-var_boxplot(variable=fulldata$mna_crops, yaxis="Avg. Acreage of Crop Patches")
largefarm_plot<-var_boxplot(variable=fulldata$largefarm_planted, yaxis="Prop. of Cropland with Lg. Farms")
ncshared_plot<-var_boxplot(variable=fulldata$te_shared_c_nc, yaxis="Natural to Crop Land Edges")
SDI_plot<-var_boxplot(variable=fulldata$SDI, yaxis="Crop Diversity")
soygrain_plot<-var_boxplot(variable=fulldata$soysmallgrain_planted, yaxis="Prop. Soybeans & Sm. Grains")
corn_plot<-var_boxplot(variable=fulldata$corn_planted, yaxis="Prop. Corn")
fruitveg_plot<-var_boxplot(variable=fulldata$fruitveg_planted, yaxis="Prop. Fruit & Veg.")

#Arrange boxplots on one page
allvarplots<-ggarrange(insect_plot, plandcrops_plot, cropintensity_plot,
             msidi_plot, mnacrops_plot, largefarm_plot, 
             ncshared_plot, SDI_plot, 
             soygrain_plot, corn_plot, fruitveg_plot, 
          labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"),
          ncol = 4, nrow = 3)

#Save the combined variable boxplots page
ggexport(allvarplots, filename = "Data/Visualize/boxplots/allvariables_trends_boxplots.png",
          width = 1800, height = 1500)

```


### Create simple geompoint graph of coefficients 

```{r point, message=F, warning=F}

library(reshape2)#wide to long dataframes
library(stringr)#String detection

cp_coef_long<-reshape2::melt(cp_coef_df, id.vars="variable")
colnames(cp_coef_long)<-c("variable", "plm", "value")

cp_coef_twoways<-cp_coef_long %>%
  dplyr::filter(stringr::str_detect(plm, "twoways"))

ggplot2::ggplot(cp_coef_twoways, aes(x=variable, y=value, color=plm))+
  geom_point()


```



### Create forest plots of the coefficients with their standard error across models

Still working on this section

Plot coefficient with SE for each variable for pooled county data, with diff colors for diff model types
Plot coefficient with its SE for each ERS; and then different colors for different models types

```{r forestplot, message=F, warning=F}


#Create lower and upper values
cpnames <- names(cp_coef_df)[-1]
cp_lower_df<-cbind(cp_coef_df[1], cp_coef_df[cpnames] - cp_se_df[match(cp_coef_df$variable, cp_se_df$variable), cpnames])
cp_upper_df<-cbind(cp_coef_df[1], cp_coef_df[cpnames] + cp_se_df[match(cp_coef_df$variable, cp_se_df$variable), cpnames])


tabletext <- cp_coef_df[,1]
fplot<-forestplot(tabletext,
           mean = cbind(cp_coef_df[, 2], cp_coef_df[, 3]),
           lower = cbind(cp_lower_df[, 2], cp_lower_df[, 3]),
           upper = cbind(cp_upper_df[, 2], cp_upper_df[, 3]))


```



### Tables of Final Models

For example:

```{r stargazer, message=F, warning=F}

panel_models_CDL_ERS_3var<-stargazer(countytime_model_CDL_ag1_3var, countytime_model_CDL_ag2_3var, countytime_model_CDL_ag3_3var, 
                                     countytime_model_CDL_ag4_3var, countytime_model_CDL_ag5_3var, countytime_model_CDL_ag6_3var, 
                                     countytime_model_CDL_ag7_3var, countytime_model_CDL_ag8_3var, countytime_model_CDL_ag9_3var,
                                     type = "text", column.labels = c("Heartland", "Northern Crescent", "Northern Great Plains",
                                                                      "Prairie Gateway", "Eastern Uplands", "Southern Seaboard",
                                                                      "Fruitful Rim", "Basin and Range", "Mississippi Portal"),
                                     out="Z:/Sofie/Data/Regressions/panel_models_CDL_EDS_3var.txt") 


```



*Add in stargazer script for models chosen to feature (after final models selected, can call desired models by loading RDA list)