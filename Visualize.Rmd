---
title: "Visualize"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown will be used to visualize the data and results developed from the Analysis.Rmd.


### Load Packages

```{r packages, message=F, warning=F}

#Load the needed packages (install first if necessary)
library(ggplot2) #data visualization
library(ggpubr)#To arrange ggplots on a page
library(stringr)#String detection
library(tidyverse) #Datatable manipulation (all functions)
library(dotwhisker) #Box and whisker plots
library(forestplot)
# library(stargazer)#regression and summary statistics tables

#Set options
  #options(scipen=999) #no scientific notation (all)

```

### Load Data

Data was cleaned up using the broom package.
More information on the package and the format of the data can be found at: 
https://cran.r-project.org/web/packages/broom/vignettes/broom.html

Using clubsandwih package to perform cluster-robust standard errors in tidy format.
For more information: https://cran.r-project.org/web/packages/clubSandwich/vignettes/panel-data-CRVE.html

```{r data, message=FALSE, warning=FALSE}

#Load fulldata
load("Data/DataProcessing/df/fulldata.rda")

#Load data for cp and ERS df with cluster-robust standard errors (CRSE) (base version is natural edges)
cp_df_coef<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest.csv")
ERS_df_coef<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest.csv")

#Also load for forest and shrubgrass edges
#Forests
cp_df_coef_forest<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest_forest.csv")
ERS_df_coef_forest<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest_forest.csv")
#Shrubgrass
cp_df_coef_shrubgrass<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest_shrubgrass.csv")
ERS_df_coef_shrubgrass<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest_shrubgrass.csv")

#Version of ERS_df_coef without crop models
ERS_df_coef_nocrops<-ERS_df_coef %>% 
  filter(model=="Var5"|model=="Var6"|model=="Var5_3yrs")

#Load data for CP and ERS df with CRSE for natural edges, forests, and shrubgrass, for robust check (_plandcrops, where %cropland (NLCD)>1)
cp_df_coef_plandcrops<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest_plandcrops.csv")
ERS_df_coef_plandcrops<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest_plandcrops.csv")
cp_df_coef_forest_plandcrops<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest_forest_plandcrops.csv")
ERS_df_coef_forest_plandcrops<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest_forest_plandcrops.csv")
cp_df_coef_shrubgrass_plandcrops<-readr::read_csv("Data/Analysis/df/CP/cp_df_coeftest_shrubgrass_plandcrops.csv")
ERS_df_coef_shrubgrass_plandcrops<- readr::read_csv ("Data/Analysis/df/ERS/ERS_df_coeftest_shrubgrass_plandcrops.csv")

```


###Examining Variables by ERS

```{r}

head(fulldata)
colnames(fulldata)
test<-fulldata %>% 
  select(FIPS, Year, msidi, ERSCode, ERSName, pland_crops,
         natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         forest_crops_ed,shrubgrass_crops_ed) %>% 
  drop_na() %>% 
  mutate(ERSCode=as.factor(ERSCode)) #Leaving out SDI otherwise a lot less rows

testper<-fulldata %>% 
  filter(pland_crops>1) %>% 
  select(FIPS, Year, msidi, ERSCode, ERSName, pland_crops,
         natural_crops_ed, mna_crops, largefarm_planted,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         forest_crops_ed,shrubgrass_crops_ed) %>% 
  drop_na()

head(test)

#Landscape diversity
#For each ERS, get the msidi values and plot, perhaps histogram
ggplot(data=test, aes(x=msidi, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0, 1, by =0.05))

ggplot(data=test, aes(x=msidi)) +
  geom_histogram(breaks=seq(0, 1, by =0.05))+
  facet_wrap(. ~ ERSCode)

#Percent cropland
ggplot(data=test, aes(x=pland_crops, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0, 100, by =1))

ggplot(data=test, aes(x=pland_crops)) +
  geom_histogram(breaks=seq(0, 100, by =5))+
  facet_wrap(. ~ ERSCode)

#Natural_crops_ed
ggplot(data=test, aes(x=natural_crops_ed, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,45, by =3))

ggplot(data=test, aes(x=natural_crops_ed)) +
  geom_histogram(breaks=seq(0,45, by =3))+
  facet_wrap(. ~ ERSCode)

#forest_crops_ed
ggplot(data=test, aes(x=forest_crops_ed, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,35, by =1))

ggplot(data=test, aes(x=forest_crops_ed)) +
  geom_histogram(breaks=seq(0,35, by =1))+
  facet_wrap(. ~ ERSCode)

#shrubgrass_crops_ed
ggplot(data=test, aes(x=shrubgrass_crops_ed, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,35, by =1))

ggplot(data=test, aes(x=shrubgrass_crops_ed)) +
  geom_histogram(breaks=seq(0,35, by =1))+
  facet_wrap(. ~ ERSCode)

#largefarm_planted
ggplot(data=test, aes(x=largefarm_planted, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,1, by =0.05))

ggplot(data=test, aes(x=largefarm_planted)) +
  geom_histogram(breaks=seq(0,1, by =0.05))+
  facet_wrap(. ~ ERSCode)


#Crop types
ggplot(data=test, aes(x=soysmallgrain_planted, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,1, by =0.05))

ggplot(data=test, aes(x=soysmallgrain_planted)) +
  geom_histogram(breaks=seq(0,1, by =0.05))+
  facet_wrap(. ~ ERSCode)

#Soy small 2002 vs other years
testsoy2002<-test %>%
  filter(Year==2002)
#Soy small 2002 vs other years
testsoy2007<-test %>%
  filter(Year==2007)

ggplot(data=testsoy2002, aes(x=soysmallgrain_planted)) +
  geom_histogram(breaks=seq(0,1, by =0.05))+
  facet_wrap(. ~ ERSCode)

ggplot(data=testsoy2007, aes(x=soysmallgrain_planted)) +
  geom_histogram(breaks=seq(0,1, by =0.05))+
  facet_wrap(. ~ ERSCode)



ggplot(data=test, aes(x=corn_planted, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,1, by =0.05))

ggplot(data=test, aes(x=corn_planted)) +
  geom_histogram(breaks=seq(0,1, by =0.05))+
  facet_wrap(. ~ ERSCode)

ggplot(data=test, aes(x=fruitveg_planted, fill=ERSCode)) + 
  geom_histogram(breaks=seq(0,1, by =0.05))

ggplot(data=test, aes(x=fruitveg_planted)) +
  geom_histogram(breaks=seq(0,1, by =0.05))+
  facet_wrap(. ~ ERSCode)


```




### Boxplots of time trends of covariates

Creating boxplots showing the values for each of the variables being considered in any of the regression models, across the years being considered. Using the fulldata datasets (loaded in the variable_boxplots.R script sourced below).


```{r var boxplots, message=F, warning=F}

#Source R script to create boxplot visualizations
source("R/Visualize/variable_boxplots.R")

#Create boxplots for variables of interest (NA values will be removed)
insect_plot<-var_boxplot(variable=fulldata$insect_planted, yaxis="Prop. Cropland w/ Insecticides")
plandcrops_plot<-var_boxplot(variable=fulldata$pland_crops, yaxis="Prop. of Cty in Cropland")
msidi_plot<-var_boxplot(variable=fulldata$msidi, yaxis="Landscape Diversity")
mnacrops_plot<-var_boxplot(variable=fulldata$mna_crops, yaxis="Avg. Acreage of Crop Patches")
largefarm_plot<-var_boxplot(variable=fulldata$largefarm_planted, yaxis="Prop. of Cropland with Lg. Farms")
ncedge_plot<-var_boxplot(variable=fulldata$natural_crops_ed, yaxis="Natural to Crop Land Edges")
SDI_plot<-var_boxplot(variable=fulldata$SDI, yaxis="Crop Diversity")
soygrain_plot<-var_boxplot(variable=fulldata$soysmallgrain_planted, yaxis="Prop. Soybeans & Sm. Grains")
corn_plot<-var_boxplot(variable=fulldata$corn_planted, yaxis="Prop. Corn")
fruitveg_plot<-var_boxplot(variable=fulldata$fruitveg_planted, yaxis="Prop. Fruit & Veg.")
fcedge_plot<-var_boxplot(variable=fulldata$forest_crops_ed , yaxis="Forest to Crop Land Edges")
sgcedge_plot<-var_boxplot(variable=fulldata$shrubgrass_crops_ed , yaxis="Shrubland and Grassland to Crop Land Edges")

#Arrange boxplots on one page
allvarplots<-ggarrange(insect_plot, plandcrops_plot,
             msidi_plot, mnacrops_plot, largefarm_plot, SDI_plot, 
             soygrain_plot, corn_plot, fruitveg_plot, 
             ncedge_plot, fcedge_plot, sgcedge_plot,
          labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"),
          ncol = 4, nrow = 3)

#Save the combined variable boxplots page
ggexport(allvarplots, filename = "Data/Visualize/boxplots/allvariables_trends_boxplots.png",
          width = 1800, height = 1500)

```


#Box and Whisker Plots (Old)

Create box and whisker plots of the model coefficients useing the dotwhisker package.

```{r}

# #Create box and whisker plots
# 
# #Using the twoways only for visualizations currently
# 
# #CP
# #Relabel predictors
# cp_plot_df <- cp_df_coef %>%
#   relabel_predictors(c(PercentCrop = "Percent Crop",
#                      LandDiversity = "Land Diversity",
#                      MeanCropArea = "Avg. Crop Area",
#                      LargeFarms = "Large Farm",
#                      NaturalCropEdge = "Natural-Crop Edge",
#                      CropDiversity= "Crop Diversity",
#                      SoyGrains= "Soy & Grains",
#                      Corn= "Corn",
#                      FruitVeg= "Fruit & Veg"))
# 
# #Can simply using dwplot function to create boxwhisker plot
# cp_plot1<-dotwhisker::dwplot(cp_plot_df,
#                              dot_args = list(size = 2),
#                             whisker_args = list(size = 0.5))+
#    theme_bw() + xlab("Coefficient Estimate") + ylab("") +
#      geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
#      ggtitle("Coefficient Comparison for Counties Pooled") +
#      theme(plot.title = element_text(face="bold", size=20),
#            legend.title = element_blank(),
#            legend.text = element_text(size=16),
#            axis.text=element_text(size=14),
#            axis.title = element_text(size=16))
# 
# ggexport(cp_plot1, filename = "Data/Visualize/boxwhisker/cp_twoways_crse_compare.png",
#           width = 1200, height = 800)
#  
# #Generate a 'small multiple' plot of cp coefficients
# cp_plot2<-dotwhisker::small_multiple(cp_plot_df,
#                                      dot_args = list(size = 1.0),
#                                      whisker_args = list(size = 0.5)) +
#   theme_bw() + ylab("Coefficient Estimate") +
#   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#   ggtitle("Coefficient Comparison for Counties Pooled") +
#   theme(text = element_text(size = 14),
#         plot.title = element_text(face = "bold", size=20), 
#         legend.position = "none",
#         axis.text.x = element_text(angle = 60, hjust = 1),
#         axis.text=element_text(size=12),
#         axis.title = element_text(size=18)) 
# 
# ggexport(cp_plot2, filename = "Data/Visualize/boxwhisker/cp_twoways_crse_multicompare.png",
#           width = 2100, height = 1500)
# 
# 
# 
# #ERS
# #Relabel predictors
# ERS_plot_df <- ERS_df_coef %>%
#   relabel_predictors(c(PercentCrop = "% Crop",
#                      LandDiversity = "Land Diversity",
#                      MeanCropArea = "Avg. Crop Area",
#                      LargeFarms = "Large Farm",
#                      NaturalCropEdge = "Natural-Crop Edge",
#                      CropDiversity= "Crop Diversity",
#                      SoyGrains= "Soy & Grains",
#                      Corn= "Corn",
#                      FruitVeg= "Fruit & Veg"))
# 
# #Create boxwhisker plot of all ERS models together
# ERS_plot1<-dotwhisker::dwplot(ERS_plot_df,
#                               dot_args = list(size = 1.4),
#                               whisker_args = list(size = 0.5))+
#      theme_bw() + xlab("Coefficient Estimate") + ylab("") +
#      geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
#      ggtitle("Coefficient Comparison for ERS") +
#      theme(plot.title = element_text(face="bold", size=20),
#            legend.title = element_blank(),
#            legend.text = element_text(size=16),
#            axis.text=element_text(size=14),
#            axis.title = element_text(size=16))
# 
# ggexport(ERS_plot1, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_compare.png",
#           width = 1200, height = 800)
# 
# 
# #For some reason small_multiple and submodels do not work
#   #So will subset by ERS and send through small_multiple
# 
# ERS<-1:9 #9 ERS Regions
#   for (e in ERS){
#     ERS_plot_df_subset<-subset(ERS_plot_df, ERS_plot_df$ERS==e)
#     
#     ERS_plot2<-dotwhisker::small_multiple(ERS_plot_df_subset,
#                                           dot_args = list(size = 1.0),
#                                           whisker_args = list(size = 0.5)) +
#       theme_bw() + ylab("Coefficient Estimate") +
#       geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#       ggtitle("Coefficient Comparison for ERS") +
#       theme(text = element_text(size = 14),
#             plot.title = element_text(face = "bold", size=20), 
#             legend.position = "none",
#             axis.text.x = element_text(angle = 60, hjust = 1),
#             axis.text=element_text(size=12),
#             axis.title = element_text(size=18))  
# 
#     ggexport(ERS_plot2, filename = paste0("Data/Visualize/boxwhisker/ERS_twoways_crse_multicompare_ERS", e, ".png"),
#              width = 2100, height = 1500)
#     
#   }#End ERS Loop
# 
# 
# #Create boxwhisker plot where ERS column called model
# ERS_plot_df_byERS<-ERS_plot_df %>% 
#   rename(plm=model,
#          model=ERS)
# ERS_plot3<-dotwhisker::dwplot(ERS_plot_df_byERS,
#                               dot_args = list(size = 1.4),
#                               whisker_args = list(size = 0.5))+
#      theme_bw() + xlab("Coefficient Estimate") + ylab("") +
#      geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
#      ggtitle("Coefficient Comparison for ERS") +
#      theme(plot.title = element_text(face="bold", size=20),
#            legend.title = element_blank(),
#            legend.text = element_text(size=16),
#            axis.text=element_text(size=14),
#            axis.title = element_text(size=16)) 
# 
# ggexport(ERS_plot3, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_compare_byERS.png",
#              width = 1200, height = 800)


```


Figure out way to put similar ERS region results together (panel of 4 with two together- such as NW, SW, NE, SE, Midwest, etc.)

```{r}

# #Trying submodels again
# 
# 
# ERS_plot_df_sub <- ERS_df_coef %>%
#   rename(submodel = ERS) %>%
#   select(-submodel, everything(), submodel) %>%
#   relabel_predictors(c(pland_crops = "% Crop",
#                      msidi = "Land Diversity",
#                      mna_crops = "Avg. Crop Area",
#                      largefarm_planted = "Large Farm",
#                      natural_crops_ed = "Natural-Crop Edge",
#                      SDI= "Crop Diversity",
#                      soysmallgrain_planted= "Soy & Grains",
#                      corn_planted= "Corn",
#                      fruitveg_planted= "Fruit & Veg"))
# 
# #Subset by ERS to graph together as submodels (max of 3 and need 0 and 1)
#   ERS_west<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==3|ERS_plot_df_sub$submodel==8)
#   ERS_west[ERS_west == 3] <- 1 #Northern Great Plains
#   ERS_west[ERS_west == 8] <- 0 #Basin and Range
#   
#   ERS_midwest<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==1|ERS_plot_df_sub$submodel==4)
#   #ERS_midwest[ERS_midwest == 1] <- 1 #Heartland
#   ERS_midwest[ERS_midwest == 4] <- 0 #Prairie Gateway
#   
#   ERS_southeast<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==6|ERS_plot_df_sub$submodel==9)
#   ERS_southeast[ERS_southeast == 6] <- 1 #Southern Seaboard
#   ERS_southeast[ERS_southeast == 9] <- 0 #Mississippi Portal
#   
#   ERS_northeast<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==2|ERS_plot_df_sub$submodel==5)
#   ERS_northeast[ERS_northeast == 2] <- 1 #Northern Crescent
#   ERS_northeast[ERS_northeast == 5] <- 0 #Eastern Uplands
#   
#   ERS_fruit<-subset(ERS_plot_df_sub, ERS_plot_df_sub$submodel==7)
# 
# #WEST
#     ERS_plot_west<-dotwhisker::small_multiple(ERS_west,
#                                           dot_args = list(size = 0.5),
#                                           whisker_args = list(size = 0.3)) +
#       theme_bw() + ylab("Coefficient Estimate") +
#       geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#       ggtitle("Coefficient Comparison for Western ERS") +
#       theme(text = element_text(size = 14),
#             plot.title = element_text(face = "bold", size=20), 
#             axis.text.x = element_text(angle = 60, hjust = 1),
#             axis.text=element_text(size=12),
#             axis.title = element_text(size=18)) +
#     scale_colour_hue(name = "ERS",
#                      breaks = c(0, 1),
#                      labels = c("Basin and Range", "Northern Great Plains"))
#     ggexport(ERS_plot_west, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_west.png",
#              width = 1500, height = 1200)
#  
# #MIDWEST   
#      ERS_plot_midwest<-dotwhisker::small_multiple(ERS_midwest,
#                                           dot_args = list(size = 0.5),
#                                           whisker_args = list(size = 0.3)) +
#       theme_bw() + ylab("Coefficient Estimate") +
#       geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#       ggtitle("Coefficient Comparison for Midwest ERS") +
#       theme(text = element_text(size = 14),
#             plot.title = element_text(face = "bold", size=20), 
#             axis.text.x = element_text(angle = 60, hjust = 1),
#             axis.text=element_text(size=12),
#             axis.title = element_text(size=18)) +
#     scale_colour_hue(name = "ERS",
#                      breaks = c(0, 1),
#                      labels = c("Prairie Gateway", "Heartland"))
#     ggexport(ERS_plot_midwest, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_midwest.png",
#              width = 1500, height = 1200)
#     
# #Southeast
#      ERS_plot_southeast<-dotwhisker::small_multiple(ERS_southeast,
#                                           dot_args = list(size = 0.5),
#                                           whisker_args = list(size = 0.3)) +
#       theme_bw() + ylab("Coefficient Estimate") +
#       geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#       ggtitle("Coefficient Comparison for Southeast ERS") +
#       theme(text = element_text(size = 14),
#             plot.title = element_text(face = "bold", size=20), 
#             axis.text.x = element_text(angle = 60, hjust = 1),
#             axis.text=element_text(size=12),
#             axis.title = element_text(size=18)) +
#     scale_colour_hue(name = "ERS",
#                      breaks = c(0, 1),
#                      labels = c("Mississippi Portal", "Southern Seaboard"))
#     ggexport(ERS_plot_southeast, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_southeast.png",
#              width = 1500, height = 1200)
#     
# #Northeast
#      ERS_plot_northeast<-dotwhisker::small_multiple(ERS_northeast,
#                                           dot_args = list(size = 0.5),
#                                           whisker_args = list(size = 0.3)) +
#       theme_bw() + ylab("Coefficient Estimate") +
#       geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#       ggtitle("Coefficient Comparison for Northeast ERS") +
#       theme(text = element_text(size = 14),
#             plot.title = element_text(face = "bold", size=20), 
#             axis.text.x = element_text(angle = 60, hjust = 1),
#             axis.text=element_text(size=12),
#             axis.title = element_text(size=18)) +
#     scale_colour_hue(name = "ERS",
#                      breaks = c(0, 1),
#                      labels = c("Eastern Uplands", "Northern Cresecent"))
#     ggexport(ERS_plot_northeast, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_northeast.png",
#              width = 1500, height = 1200)
#     
# #Fruitful Rim
#      ERS_plot_fruit<-dotwhisker::small_multiple(ERS_fruit,
#                                           dot_args = list(size = 0.5),
#                                           whisker_args = list(size = 0.3)) +
#       theme_bw() + ylab("Coefficient Estimate") +
#       geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
#       ggtitle("Coefficient Comparison for Fruitful Rim ERS") +
#       theme(text = element_text(size = 14),
#             plot.title = element_text(face = "bold", size=20), 
#             axis.text.x = element_text(angle = 60, hjust = 1),
#             axis.text=element_text(size=12),
#             axis.title = element_text(size=18))+
#         scale_colour_hue(name = "ERS",
#                      breaks = c(7),
#                      labels = c("Fruitful Rim"))
#     ggexport(ERS_plot_fruit, filename = "Data/Visualize/boxwhisker/ERS_twoways_crse_fruit.png",
#              width = 1500, height = 1200)
# #Just make and save all 5 and then bind them in the PDF and give good title
#     #Currrently too large to panel them
#     
#     #Also do it for regular dwplot and separate into regions- those can be stacked next to each easier

```


#Errorbar charts

###CP and ERS 


```{r}

#Plot CP on x and coefficient for each model with SD facet by term
#Relabel predictors
cp_plot_df <- cp_df_coef %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))
library(ggplot2)
CPcompare<-ggplot(cp_plot_df, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18),
          legend.text=element_text(size=16))


ggexport(CPcompare, filename = "Data/Visualize/boxwhisker/CPcompare.png",
             width = 1500, height = 1200)

#Plot ERS on x and coefficient for each model with SD facet by term
ERS_subset <- ERS_df_coef %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
ERScompare<-ggplot(ERS_subset, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare, filename = "Data/Visualize/boxwhisker/ERScompare.png",
             width = 1500, height = 1200)


```



For forest and shrubgrass edges just doing errorbar maps

####Forests

```{r}

#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
cp_plot_df_forest <- cp_df_coef_forest %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ForestCropEdge = "Forest-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_Forest<-ggplot(cp_plot_df_forest, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_Forest, filename = "Data/Visualize/boxwhisker/CPcompare_Forest.png",
             width = 1500, height = 1200)

ERS_subset_forest<- ERS_df_coef_forest %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ForestCropEdge = "Forest-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
ERScompare_Forest<-ggplot(ERS_subset_forest, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_Forest, filename = "Data/Visualize/boxwhisker/ERScompare_Forest.png",
             width = 1500, height = 1200)

```


####Shrublands and Grasslands

```{r}

#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
cp_plot_df_shrubgrass <- cp_df_coef_shrubgrass %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ShrubGrassCropEdge = "Shrub & Grass-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_ShrubGrass<-ggplot(cp_plot_df_shrubgrass, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_ShrubGrass, filename = "Data/Visualize/boxwhisker/CPcompare_ShrubGrass.png",
             width = 1500, height = 1200)

ERS_subset_shrubgrass<- ERS_df_coef_shrubgrass %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ShrubGrassCropEdge = "Shrub & Grass-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
ERScompare_ShrubGrass<-ggplot(ERS_subset_shrubgrass, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_ShrubGrass, filename = "Data/Visualize/boxwhisker/ERScompare_ShrubGrass.png",
             width = 1500, height = 1200)

```



### Separate CP by years- three/four years

```{r}

library(ggplot2)

cp_plot_df_4yrs<-cp_df_coef %>%
  dplyr::filter(model=="Var5"|model=="Var5_crops") %>% 
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_4yrs<-ggplot(cp_plot_df_4yrs, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_4yrs, filename = "Data/Visualize/boxwhisker/CPcompare_4yrs.png",
             width = 1500, height = 1200)



cp_plot_df_3yrs<-cp_df_coef %>%
  dplyr::filter(model!="Var5"&model!="Var5_crops") %>% 
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_3yrs<-ggplot(cp_plot_df_3yrs, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_3yrs, filename = "Data/Visualize/boxwhisker/CPcompare_3yrs.png",
             width = 1500, height = 1200)



#Color code years
library(ggplot2)

cp_plot_df_yrs<-cp_df_coef %>%
  dplyr::mutate(years=ifelse(model=="Var5"|model=="Var5_crops", "4 years", "3 years")) %>% 
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_yrs<-ggplot(cp_plot_df_yrs, aes(x = model, color=years)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_yrs, filename = "Data/Visualize/boxwhisker/CPcompare_yrs.png",
             width = 1500, height = 1200)



ERS_plot_df_yrs<- ERS_df_coef %>%
   dplyr::mutate(years=ifelse(model=="Var5"|model=="Var5_crops", "4 years", "3 years")) %>% 
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ShrubGrassCropEdge = "Shrub & Grass-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
ERScompare_yrs<-ggplot(ERS_plot_df_yrs, aes(x = factor(ERS), color = years)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_yrs, filename = "Data/Visualize/boxwhisker/ERScompare_yrs.png",
             width = 1500, height = 1200)


```


###Without crop models

```{r}

ERS_subset_nocrops <- ERS_df_coef_nocrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity"))

#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
ERScompare_nocrops<-ggplot(ERS_subset_nocrops, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_nocrops, filename = "Data/Visualize/boxwhisker/ERScompare_nocrops.png",
             width = 1500, height = 1200)

```

### Robust check (plandcrops>1)

```{r}

#Natural
#Plot CP on x and coefficient for each model with SD facet by term
#Relabel predictors
cp_plot_df_plandcrops <- cp_df_coef_plandcrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))
library(ggplot2)
CPcompare_plandcrops<-ggplot(cp_plot_df_plandcrops, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18),
          legend.text=element_text(size=16))


ggexport(CPcompare_plandcrops, filename = "Data/Visualize/boxwhisker/CPcompare_plandcrops.png",
             width = 1500, height = 1200)


#ERS natural_edge
ERS_subset_plandcrops <- ERS_df_coef_plandcrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     NaturalCropEdge = "Natural-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
ERScompare_plandcrops<-ggplot(ERS_subset_plandcrops, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_plandcrops, filename = "Data/Visualize/boxwhisker/ERScompare_plandcrops.png",
             width = 1500, height = 1200)



#Forest
#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
cp_plot_df_forest_plandcrops <- cp_df_coef_forest_plandcrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ForestCropEdge = "Forest-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_Forest_plandcrops<-ggplot(cp_plot_df_forest_plandcrops, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_Forest_plandcrops, filename = "Data/Visualize/boxwhisker/CPcompare_Forest_plandcrops.png",
             width = 1500, height = 1200)

ERS_subset_forest_plandcrops<- ERS_df_coef_forest_plandcrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ForestCropEdge = "Forest-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
ERScompare_Forest_plandcrops<-ggplot(ERS_subset_forest_plandcrops, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_Forest_plandcrops, filename = "Data/Visualize/boxwhisker/ERScompare_Forest_plandcrops.png",
             width = 1500, height = 1200)



#Shrubgrass
#Plot ERS on x and coefficient for each model with SD facet by term
library(ggplot2)
cp_plot_df_shrubgrass_plandcrops <- cp_df_coef_shrubgrass_plandcrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ShrubGrassCropEdge = "Shrub & Grass-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

CPcompare_ShrubGrass_plandcrops<-ggplot(cp_plot_df_shrubgrass_plandcrops, aes(x = model, color=model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate")+ labs(color="Model")+xlab("")+
  facet_wrap(~term)+
  theme(text = element_text(size = 14),
            axis.text.x=element_blank(),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
            legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(CPcompare_ShrubGrass_plandcrops, filename = "Data/Visualize/boxwhisker/CPcompare_ShrubGrass_plandcrops.png",
             width = 1500, height = 1200)

ERS_subset_shrubgrass_plandcrops<- ERS_df_coef_shrubgrass_plandcrops %>%
  relabel_predictors(c(PercentCrop = "Percent Crop",
                     LandDiversity = "Land Diversity",
                     MeanCropArea = "Avg. Crop Area",
                     LargeFarms = "Large Farm",
                     ShrubGrassCropEdge = "Shrub & Grass-Crop Edge",
                     CropDiversity= "Crop Diversity",
                     SoyGrains= "Soy & Grains",
                     Corn= "Corn",
                     FruitVeg= "Fruit & Veg"))

#Plot ERS on x and coefficient for each model with SD facet by term
ERScompare_ShrubGrass_plandcrops<-ggplot(ERS_subset_shrubgrass_plandcrops, aes(x = factor(ERS), color = model)) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error),
                position = "dodge")+
  facet_wrap(~term, scale="free")+
   geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  theme_bw() + ylab("Coefficient Estimate") + xlab("ERS")+ labs(color="Model")+
  theme(text = element_text(size = 14),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18),
          strip.text.x = element_text(size = 16),
          legend.title=element_text(size=18), 
          legend.text=element_text(size=16))


ggexport(ERScompare_ShrubGrass_plandcrops, filename = "Data/Visualize/boxwhisker/ERScompare_ShrubGrass_plandcrops.png",
             width = 1500, height = 1200)



```



### Tables of Final Models

Add to this section once final models are decided on. 
Will load and select final models from rda files, and then put together in a stargazer table.
Otherwise will just use kabletable on the created dataframes.

For example:

```{r stargazer, message=F, warning=F}


# panel_models_CDL_ERS_3var<-stargazer(countytime_model_CDL_ag1_3var, countytime_model_CDL_ag2_3var, countytime_model_CDL_ag3_3var, 
#                                      countytime_model_CDL_ag4_3var, countytime_model_CDL_ag5_3var, countytime_model_CDL_ag6_3var, 
#                                      countytime_model_CDL_ag7_3var, countytime_model_CDL_ag8_3var, countytime_model_CDL_ag9_3var,
#                                      type = "text", column.labels = c("Heartland", "Northern Crescent", "Northern Great Plains",
#                                                                       "Prairie Gateway", "Eastern Uplands", "Southern Seaboard",
#                                                                       "Fruitful Rim", "Basin and Range", "Mississippi Portal"),
#                                      out="Z:/Sofie/Data/Regressions/panel_models_CDL_EDS_3var.txt") 


```


### Examine spatially what variables look like per county/ERS region

Create map figure with the SD over time of each of the regression variables/covariates (color code of SD between the years)-instead of the all the year numbers

```{r}

#Need the shapefile- reading in from computer but eventually maybe store it on github
#Read in FIPS county shapefile
library(sf)
library(tidyverse)
#library(ggplot2)


counties<-read_sf(dsn = "C:/Users/shemc/Documents/UCSB/NLCD/Data/TIGER2018_Counties", layer = "tl_2018_us_county") %>%  
  dplyr::mutate(FIPS=paste0(STATEFP,COUNTYFP))
contig48_counties<-subset(counties,counties$STATEFP!="02"& counties$STATEFP!="15"&
                              counties$STATEFP!="60"&counties$STATEFP!="66"&
                              counties$STATEFP!="69"&counties$STATEFP!="72"&
                              counties$STATEFP!="74"&counties$STATEFP!="78") %>% 
  select(FIPS) %>% #only CONUS counties and just need FIPS
  dplyr::mutate(FIPS=as.numeric(FIPS))
#Load fulldata
load("Data/DataProcessing/df/fulldata.rda")
counties_data <- merge(contig48_counties, fulldata, by='FIPS') %>% 
  select(FIPS, Year, ERSCode, ASDCode, insect_planted, pland_crops, SDI,
         largefarm_planted, mna_crops, natural_crops_ed, msidi,
         soysmallgrain_planted, corn_planted, fruitveg_planted,
         forest_crops_ed, shrubgrass_crops_ed)

#Averages
counties_avg<-counties_data %>% 
  group_by(FIPS) %>%
  summarize(insect_avg=mean(insect_planted, na.rm=TRUE),
            plandcrops_avg=mean(pland_crops, na.rm=TRUE),
            cropdiversity_avg=mean(SDI, na.rm=TRUE),
            largefarm_avg=mean(largefarm_planted, na.rm=TRUE),
            mnacrops_avg=mean(mna_crops, na.rm=TRUE),
            ncedge_avg=mean(natural_crops_ed, na.rm=TRUE),
            landdiversity_avg=mean(msidi, na.rm=TRUE),
            soygrain_avg=mean(soysmallgrain_planted, na.rm=TRUE),
            corn_avg=mean(corn_planted, na.rm=TRUE),
            fruitveg_avg=mean(fruitveg_planted, na.rm=TRUE),
            fcedge_avg=mean(forest_crops_ed, na.rm=TRUE),
            sgcedge_avg=mean(shrubgrass_crops_ed, na.rm=TRUE))

#SD
counties_sd<-counties_data %>% 
  group_by(FIPS) %>%
  summarize(insect_sd=sd(insect_planted, na.rm=TRUE),
            plandcrops_sd=sd(pland_crops, na.rm=TRUE),
            cropdiversity_sd=sd(SDI, na.rm=TRUE),
            largefarm_sd=sd(largefarm_planted, na.rm=TRUE),
            mnacrops_sd=sd(mna_crops, na.rm=TRUE),
            ncedge_sd=sd(natural_crops_ed, na.rm=TRUE),
            landdiversity_sd=sd(msidi, na.rm=TRUE),
            soygrain_sd=sd(soysmallgrain_planted, na.rm=TRUE),
            corn_sd=sd(corn_planted, na.rm=TRUE),
            fruitveg_sd=sd(fruitveg_planted, na.rm=TRUE),
            fcedge_sd=sd(forest_crops_ed, na.rm=TRUE),
            sgcedge_sd=sd(shrubgrass_crops_ed, na.rm=TRUE))

#ERS Crosswalk
#Read in ERS file, to be combined with other data as is
ERS<-readxl::read_xls("Data/DataProcessing/ERS/ERSRegions_To_Counties.xls")
ERS<-ERS[,1:3]
colnames(ERS)<-c("FIPS", "ERSCode", "ERSName")

#Merge files with ERS by  FIPS
counties_avg<-list(counties_avg, ERS) %>% 
  reduce(full_join, by=c("FIPS"))
counties_sd<-list(counties_sd, ERS) %>% 
  reduce(full_join, by=c("FIPS"))

#Save these df and move to GIS
sf::st_write(counties_avg, "Data/Visualize/variablemaps/counties_avg.shp")
sf::st_write(counties_sd, "Data/Visualize/variablemaps/counties_sd.shp")

#Also add ERS so you can make county lines light and then ERS lines dark and map avg/sd by county and see how ERS differ
#Averages
counties_avg_ERS<-counties_data %>% 
  group_by(ERSCode) %>%
  summarize(insect_avg=mean(insect_planted, na.rm=TRUE),
            plandcrops_avg=mean(pland_crops, na.rm=TRUE),
            cropdiversity_avg=mean(SDI, na.rm=TRUE),
            largefarm_avg=mean(largefarm_planted, na.rm=TRUE),
            mnacrops_avg=mean(mna_crops, na.rm=TRUE),
            ncedge_avg=mean(natural_crops_ed, na.rm=TRUE),
            landdiversity_avg=mean(msidi, na.rm=TRUE),
            soygrain_avg=mean(soysmallgrain_planted, na.rm=TRUE),
            corn_avg=mean(corn_planted, na.rm=TRUE),
            fruitveg_avg=mean(fruitveg_planted, na.rm=TRUE),
            fcedge_avg=mean(forest_crops_ed, na.rm=TRUE),
            sgcedge_avg=mean(shrubgrass_crops_ed, na.rm=TRUE))

#SD
counties_sd_ERS<-counties_data %>% 
  group_by(ERSCode) %>%
  summarize(insect_sd=sd(insect_planted, na.rm=TRUE),
            plandcrops_sd=sd(pland_crops, na.rm=TRUE),
            cropdiversity_sd=sd(SDI, na.rm=TRUE),
            largefarm_sd=sd(largefarm_planted, na.rm=TRUE),
            mnacrops_sd=sd(mna_crops, na.rm=TRUE),
            ncedge_sd=sd(natural_crops_ed, na.rm=TRUE),
            landdiversity_sd=sd(msidi, na.rm=TRUE),
            soygrain_sd=sd(soysmallgrain_planted, na.rm=TRUE),
            corn_sd=sd(corn_planted, na.rm=TRUE),
            fruitveg_sd=sd(fruitveg_planted, na.rm=TRUE),
            fcedge_sd=sd(forest_crops_ed, na.rm=TRUE),
            sgcedge_sd=sd(shrubgrass_crops_ed, na.rm=TRUE))

#Save these df and move to GIS
sf::st_write(counties_avg_ERS, "Data/Visualize/variablemaps/counties_avg_ERS.shp")
sf::st_write(counties_sd_ERS, "Data/Visualize/variablemaps/counties_sd_ERS.shp")

library(tmap) #Takes a long time to map-perhaps in GIS?

# #Insecticides
# tm_shape(counties_sd)+
#   tm_fill("insect_sd", 
#           title = "Insecticides",
#           breaks = c(0, 0.05, 0.10, 0.25, 0.5, 0.75, 1),
#           style = "fixed",
#           textNA = "No data",
#           colorNA = "white", 
#           palette = "Reds")+
#   tm_borders(col = "gray40", lwd = 1)





```

