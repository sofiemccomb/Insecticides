---
title: "Visualize"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This R Markdown will be used to visualize the data and results developed from the Analysis.Rmd.


### Load Packages

```{r packages, message=F, warning=F}

#Load the needed packages (install first if necessary)
library(ggplot2) #data visualization
library(ggpubr)#To arrange ggplots on a page
library(stringr)#String detection
library(tidyverse) #Datatable manipulation (all functions)
library(dotwhisker) #Box and whisker plots
  # library(tools) #For file_path sans_ext (COA.R)
  # library(purrr) #For reduce function using full_join (COA.R)
  # library(zoo) #For na.locf function (COA.R)
  # library(janitor) #Clean colnames (CDL.R)
  # library(vegan) #Perform diversity calculation (CDL.R)
  # library(readxl) #read excel .xlsx (ERS data)
library(forestplot)
# library(stargazer)#regression and summary statistics tables
# library(plm) #linear models for panel data
# library(lmtest) #testing for linear regression models

#Set options
  #options(scipen=999) #no scientific notation (all)

```

### Load Data

Data was cleaned up using the broom package. 
More information on the package and the format of the data can be found at: 
https://cran.r-project.org/web/packages/broom/vignettes/broom.html

```{r data, message=FALSE, warning=FALSE}

#Load data for cp and ERS df
cp_df<-readr::read_csv("Data/Analysis/df/CP/cp_df.csv")
ERS_df<- readr::read_csv ("Data/Analysis/df/ERS/ERS_all.csv")

#Load fulldata
load("Data/DataProcessing/df/fulldata.rda")

```


### Boxplots of time trends of covariates

Creating boxplots showing the values for each of the variables being considered in any of the regression models, across the years being considered. Using the fulldata datasets (loaded in the variable_boxplots.R script sourced below).


```{r var boxplots, message=F, warning=F}

#Source R script to create boxplot visualizations
source("R/Visualize/variable_boxplots.R")

#Create boxplots for variables of interest (NA values will be removed)
insect_plot<-var_boxplot(variable=fulldata$insect_planted, yaxis="Prop. Cropland w/ Insecticides")
plandcrops_plot<-var_boxplot(variable=fulldata$pland_crops, yaxis="Prop. of Cty in Cropland")
cropintensity_plot<-var_boxplot(variable=fulldata$cropintensity, yaxis="Cropland Intensity")
msidi_plot<-var_boxplot(variable=fulldata$msidi, yaxis="Landscape Diversity")
mnacrops_plot<-var_boxplot(variable=fulldata$mna_crops, yaxis="Avg. Acreage of Crop Patches")
largefarm_plot<-var_boxplot(variable=fulldata$largefarm_planted, yaxis="Prop. of Cropland with Lg. Farms")
ncshared_plot<-var_boxplot(variable=fulldata$te_shared_c_nc, yaxis="Natural to Crop Land Edges")
SDI_plot<-var_boxplot(variable=fulldata$SDI, yaxis="Crop Diversity")
soygrain_plot<-var_boxplot(variable=fulldata$soysmallgrain_planted, yaxis="Prop. Soybeans & Sm. Grains")
corn_plot<-var_boxplot(variable=fulldata$corn_planted, yaxis="Prop. Corn")
fruitveg_plot<-var_boxplot(variable=fulldata$fruitveg_planted, yaxis="Prop. Fruit & Veg.")

#Arrange boxplots on one page
allvarplots<-ggarrange(insect_plot, plandcrops_plot, cropintensity_plot,
             msidi_plot, mnacrops_plot, largefarm_plot, 
             ncshared_plot, SDI_plot, 
             soygrain_plot, corn_plot, fruitveg_plot, 
          labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"),
          ncol = 4, nrow = 3)

#Save the combined variable boxplots page
ggexport(allvarplots, filename = "Data/Visualize/boxplots/allvariables_trends_boxplots.png",
          width = 1800, height = 1500)

```


### Filter out models by fixed groups

```{r groups, message=F, warning=F}

#Find ways to filter out by fixed groups (separate model into columns by _)
cp_twoways<-cp_df%>%
  dplyr::filter(stringr::str_detect(model, "twoways"))


```


#Box and Whisker Plots

Create box and whisker plots of the model coefficients useing the dotwhisker package.

```{r}

#Create box and whisker plots

#CP
#Relabel predictors
cp_plot_df <- cp_df %>%
  relabel_predictors(c(pland_crops = "% Crop",
                     cropintensity = "Crop Intensity",
                     msidi = "Land Diversity",
                     mna_crops = "Avg. Crop Area",
                     largefarm_planted = "Large Farm",
                     te_shared_c_nc = "Natural-Crop Edge",
                     SDI= "Crop Diversity",
                     soysmallgrain_planted= "Soy & Grains",
                     corn_planted= "Corn",
                     fruitveg_planted= "Fruit & Veg"))

#Can simply using dwplot function to create boxwhisker plot
cp_plot1<-dotwhisker::dwplot(cp_plot_df,
                             dot_args = list(size = 2),
                            whisker_args = list(size = 0.5))+
   theme_bw() + xlab("Coefficient Estimate") + ylab("") +
     geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
     ggtitle("Coefficient Comparison for Counties Pooled") +
     theme(plot.title = element_text(face="bold", size=20),
           legend.title = element_blank(),
           legend.text = element_text(size=16),
           axis.text=element_text(size=14),
           axis.title = element_text(size=16))

ggexport(cp_plot1, filename = "Data/Visualize/boxwhisker/cp_coeff_compare.png",
          width = 1200, height = 800)
 
#Generate a 'small multiple' plot of cp coefficients
cp_plot2<-dotwhisker::small_multiple(cp_plot_df,
                                     dot_args = list(size = 1.0),
                                     whisker_args = list(size = 0.5)) +
  theme_bw() + ylab("Coefficient Estimate") +
  geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  ggtitle("Coefficient Comparison for Counties Pooled") +
  theme(text = element_text(size = 14),
        plot.title = element_text(face = "bold", size=20), 
        legend.position = "none",
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.text=element_text(size=12),
        axis.title = element_text(size=18)) 

ggexport(cp_plot2, filename = "Data/Visualize/boxwhisker/cp_coeff_multicompare.png",
          width = 2100, height = 1500)



#ERS
#Relabel predictors
ERS_plot_df <- ERS_df %>%
  relabel_predictors(c(pland_crops = "% Crop",
                     cropintensity = "Crop Intensity",
                     msidi = "Land Diversity",
                     mna_crops = "Avg. Crop Area",
                     largefarm_planted = "Large Farm",
                     te_shared_c_nc = "Natural-Crop Edge",
                     SDI= "Crop Diversity",
                     soysmallgrain_planted= "Soy & Grains",
                     corn_planted= "Corn",
                     fruitveg_planted= "Fruit & Veg"))

#Create boxwhisker plot of all ERS models together
ERS_plot1<-dotwhisker::dwplot(ERS_plot_df,
                              dot_args = list(size = 1.4),
                              whisker_args = list(size = 0.5))+
     theme_bw() + xlab("Coefficient Estimate") + ylab("") +
     geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
     ggtitle("Coefficient Comparison for ERS") +
     theme(plot.title = element_text(face="bold", size=20),
           legend.title = element_blank(),
           legend.text = element_text(size=16),
           axis.text=element_text(size=14),
           axis.title = element_text(size=16))

ggexport(ERS_plot1, filename = "Data/Visualize/boxwhisker/ERS_coeff_compare.png",
          width = 1200, height = 800)


#For some reason small_multiple and submodels do not work
  #So will subset by ERS and send through small_multiple

ERS<-1:9 #9 ERS Regions
  for (e in ERS){
    ERS_plot_df_subset<-subset(ERS_plot_df, ERS_plot_df$ERS==e)
    
    ERS_plot2<-dotwhisker::small_multiple(ERS_plot_df_subset,
                                          dot_args = list(size = 1.0),
                                          whisker_args = list(size = 0.5)) +
      theme_bw() + ylab("Coefficient Estimate") +
      geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
      ggtitle("Coefficient Comparison for ERS") +
      theme(text = element_text(size = 14),
            plot.title = element_text(face = "bold", size=20), 
            legend.position = "none",
            axis.text.x = element_text(angle = 60, hjust = 1),
            axis.text=element_text(size=12),
            axis.title = element_text(size=18))  

    ggexport(ERS_plot2, filename = paste0("Data/Visualize/boxwhisker/ERS_coeff_multicompare_ERS", e, ".png"),
             width = 2100, height = 1500)
    
  }#End ERS Loop


#Create boxwhisker plot where ERS column called model
ERS_plot_df_byERS<-ERS_plot_df %>% 
  rename(plm=model,
         model=ERS)
ERS_plot3<-dotwhisker::dwplot(ERS_plot_df_byERS,
                              dot_args = list(size = 1.4),
                              whisker_args = list(size = 0.5))+
     theme_bw() + xlab("Coefficient Estimate") + ylab("") +
     geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
     ggtitle("Coefficient Comparison for ERS") +
     theme(plot.title = element_text(face="bold", size=20),
           legend.title = element_blank(),
           legend.text = element_text(size=16),
           axis.text=element_text(size=14),
           axis.title = element_text(size=16)) 

ggexport(ERS_plot3, filename = "Data/Visualize/boxwhisker/ERS_coeff_compare_byERS.png",
             width = 1200, height = 800)


```





### Tables of Final Models

Add to this section once final models are decided on. 
Will load and select final models from rda files, and then put together in a stargazer table.
Otherwise will just use kabletable on the created dataframes.

For example:

```{r stargazer, message=F, warning=F}


# panel_models_CDL_ERS_3var<-stargazer(countytime_model_CDL_ag1_3var, countytime_model_CDL_ag2_3var, countytime_model_CDL_ag3_3var, 
#                                      countytime_model_CDL_ag4_3var, countytime_model_CDL_ag5_3var, countytime_model_CDL_ag6_3var, 
#                                      countytime_model_CDL_ag7_3var, countytime_model_CDL_ag8_3var, countytime_model_CDL_ag9_3var,
#                                      type = "text", column.labels = c("Heartland", "Northern Crescent", "Northern Great Plains",
#                                                                       "Prairie Gateway", "Eastern Uplands", "Southern Seaboard",
#                                                                       "Fruitful Rim", "Basin and Range", "Mississippi Portal"),
#                                      out="Z:/Sofie/Data/Regressions/panel_models_CDL_EDS_3var.txt") 


```

