---
title: "Data Processing"
author: "Sofie McComb"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


This R markdown document will gather and process the data necessary to perform the panel analyses laid out under the Analysis.Rmd. The data sources necessary for the analysis include up-to-date data for the Census of Agriculture (COA), USDA NASS Cropland Data Layer (CDL),National Land Cover Database (NLCD), and USDA Farm Resource Regions (Economic Service Research: ERS). The necessary data from each dataset will be gathered and combined together to have a full dataset in which each row is a unique County FIPS cod (determined by TIGER county shapefiles) per year of analysis (1997, 2002, 2007, 2012, 2017) where data availble.

The data to gather includes:  

1. COA
    * County Area, Planted Area, Harvested Area, Failed Area 
    * Total insecticides, Fertilizer, crop categories, irrigation, net cash income, large farm acreage
2. CDL
    * Crop diversity
3. NLCD
    * Patch/diversity metrics: Edge density, edge length, mean patch area, percentage of landscape, landscape diversity
4. ERS Regions  


More detail for each dataset will be given below as the data for each dataset is gathered and processed.


## Data Formatting

```{r packages, message=F, warning=F}

#Load the needed packages, which are loaded in the R scrips as well (install first if necessary)
  library(tidyverse) #Datatable manipulation (all functions)
  library(tools) #For file_path sans_ext (COA.R)
  library(purrr) #For reduce function using full_join (COA.R)
  library(zoo) #For na.locf function (COA.R)
  library(janitor) #Clean colnames (CDL.R)
  library(vegan) #Perform diversity calculation (CDL.R)
  library(readxl) #read excel .xlsx (ERS data)

#Set options
  options(scipen=999) #no scientific notation (all)

```


### 1) Census of Agriculture

```{r COA, message=F, warning=F}

#Prepare Census of Agriculture data (COA) needed for the regression analyses
source ("R/DataProcessing/COA.R")
#Output saved as Data/DataProcessing/df/coa.csv

```


### 2) CDL

```{r CDL, message=F, warning=F}

#Prepare Cropland Data Layer data (CDL) needed for the regression analyses
source ("R/DataProcessing/CDL.R")
#Output saved as Data/DataProcessing/df/cdl.csv

```



### 3) NLCD


```{r NLCD, message=F, warning=F}

#Prepare National Land Cover Database (NLCD) analyses needed for the regression analyses, which have already been run through fragstats using the R/NF.R script 
source ("R/DataProcessing/NLCD.R")
#Output saved as Data/DataProcessing/df/nlcd.csv

```



### 4) ERS

```{r ERS, message=F, warning=F}

#Read in ERS file, to be combined with other data as is
ERS<-readxl::read_xls("Data/DataProcessing/ERS/ERSRegions_To_Counties.xls")
ERS<-ERS[,1:3]
colnames(ERS)<-c("FIPS", "ERSCode", "ERSName")


```



## Data Combination

Combine the COA, CDL, NLCD, and ERS data to create final dataframe to be saved and used in regression analyses (Analysis.Rmd)


```{r combine, message=F, warning=F}

#Read in the datasets
coa<-readr::read_csv("Data/DataProcessing/df/coa.csv")
cdl<-readr::read_csv("Data/DataProcessing/df/cdl.csv")
nlcd<-readr::read_csv("Data/DataProcessing/df/nlcd.csv")

#List and merge three datasets by the unique combination of FIPS and Year Values
fulldata<-list(coa, cdl, nlcd) %>% 
  reduce(full_join, by=c("FIPS", "Year"))

#Merge with ERS by just FIPS
fulldata<-list(fulldata, ERS) %>% 
  reduce(full_join, by=c("FIPS"))

#Drop the 9 VA counties 51515, 51530, 51580, 51595, 51600, 51610, 51678,51685, 51720 
  #that had NA in CDL and that are essentially within other counties
fulldata<-fulldata %>%
  filter(!(FIPS==51515)&!(FIPS==51530)&!(FIPS==51580)&!(FIPS==51595)&!(FIPS==51600)&
           !(FIPS==51610)&!(FIPS==51678)&!(FIPS==51685)&!(FIPS==51720))

#Explore the COA data missing
  #Going to currently leave in the other counties that are suffering similar issues (no CoA data) as they will be dropped with the regression 
  #Most are FIPS for areas that made part of a county become an independent city (almost all in VA)
  #Good explanation here: http://www.nber.org/asg/ASG_release/County_City/FIPS/FIPS_Changes.pdf
  #Those counties are: 
    #11001, 24510, 29510, 46113, 51510, 51520, 51540, 51570, 51590, 51620, 51630, 51640, 51650, 51660, 51670, 51680, 51683, 51690, 51700, 51710, 51730, 51735, 51740, 51750, 51760, 51770, 51775, 51790, 51820, 51830, 51840, 8014, 51560, 51780, 12025, 30113

#Add in column calculating Crop Intensity needed for regression
  #harvcrop/((pland_crops/100)*countyarea)
  #Harvested Crop Acreage/Crop Land Acreage, 
    #where both acreages (harvcrop and countryarea) are from CoA and
    #pland_crops is from the NLCD

fulldata<-fulldata %>% 
  dplyr::mutate(cropintensity=harvcrop/((pland_crops/100)*countyarea))
  
#Replace infinite values with NA for regression 
  fulldata$cropintensity[sapply(fulldata$cropintensity, is.infinite)]<-NA
    
#Write fulldata to df folder be used in regression analyses
    write_csv(fulldata, "Data/DataProcessing/df/fulldata.csv")
    save(fulldata, file = "Data/DataProcessing/df/fulldata.rda")

```
